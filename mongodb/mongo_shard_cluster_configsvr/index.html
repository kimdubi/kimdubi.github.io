<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MongoDB Sharded Cluster - Config server | kimDuBiA</title><meta name=keywords content="mongodb"><meta name=description content="지난 글에서 mongodb shard cluster 개념과 구성하는 방법에 대해 소개드렸고 이번 글에서는 구성요소 중 하나인 config server에 대해 다루겠습니다.
Config server 란? config server는 shard cluster에서 필요한 모든 메타 정보들을 저장함
메타정보에는 어느 chunk , 즉 어떤 data 가 어떤 shard 에 있는지, chunk 의 밸런싱 작업은 어떻게 해야할지 등의 메타정보와 사용자 인증 정보가 저장됨
이렇게 중요한 정보들을 담고 있어서 가용성을 위해 하나의 replSet 으로 구성되어야 함
 config server 정보  repl_conf:PRIMARY> use config; switched to db config repl_conf:PRIMARY> show collections; actionlog changelog chunks collections databases lockpings locks migrations mongos shards system."><meta name=author content="kimdubi"><link rel=canonical href=/mongodb/mongo_shard_cluster_configsvr/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.2dbef8664bbfb3e83a0a44fd4a8fc5010240dbcd1dbc1400753b928b497b8f5e.css integrity="sha256-Lb74Zku/s+g6CkT9So/FAQJA280dvBQAdTuSi0l7j14=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-123-45','auto');ga('send','pageview');}</script><meta property="og:title" content="MongoDB Sharded Cluster - Config server"><meta property="og:description" content="지난 글에서 mongodb shard cluster 개념과 구성하는 방법에 대해 소개드렸고 이번 글에서는 구성요소 중 하나인 config server에 대해 다루겠습니다.
Config server 란? config server는 shard cluster에서 필요한 모든 메타 정보들을 저장함
메타정보에는 어느 chunk , 즉 어떤 data 가 어떤 shard 에 있는지, chunk 의 밸런싱 작업은 어떻게 해야할지 등의 메타정보와 사용자 인증 정보가 저장됨
이렇게 중요한 정보들을 담고 있어서 가용성을 위해 하나의 replSet 으로 구성되어야 함
 config server 정보  repl_conf:PRIMARY> use config; switched to db config repl_conf:PRIMARY> show collections; actionlog changelog chunks collections databases lockpings locks migrations mongos shards system."><meta property="og:type" content="article"><meta property="og:url" content="/mongodb/mongo_shard_cluster_configsvr/"><meta property="og:image" content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="mongodb"><meta property="article:published_time" content="2021-10-05T09:03:46+09:00"><meta property="article:modified_time" content="2021-10-05T09:03:46+09:00"><meta property="og:site_name" content="kimDuBiA"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="MongoDB Sharded Cluster - Config server"><meta name=twitter:description content="지난 글에서 mongodb shard cluster 개념과 구성하는 방법에 대해 소개드렸고 이번 글에서는 구성요소 중 하나인 config server에 대해 다루겠습니다.
Config server 란? config server는 shard cluster에서 필요한 모든 메타 정보들을 저장함
메타정보에는 어느 chunk , 즉 어떤 data 가 어떤 shard 에 있는지, chunk 의 밸런싱 작업은 어떻게 해야할지 등의 메타정보와 사용자 인증 정보가 저장됨
이렇게 중요한 정보들을 담고 있어서 가용성을 위해 하나의 replSet 으로 구성되어야 함
 config server 정보  repl_conf:PRIMARY> use config; switched to db config repl_conf:PRIMARY> show collections; actionlog changelog chunks collections databases lockpings locks migrations mongos shards system."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Mongodbs","item":"/mongodb/"},{"@type":"ListItem","position":3,"name":"MongoDB Sharded Cluster - Config server","item":"/mongodb/mongo_shard_cluster_configsvr/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MongoDB Sharded Cluster - Config server","name":"MongoDB Sharded Cluster - Config server","description":"지난 글에서 mongodb shard cluster 개념과 구성하는 방법에 대해 소개드렸고 이번 글에서는 구성요소 중 하나인 config server에 대해 다루겠습니다.\nConfig server 란? config server는 shard cluster에서 필요한 모든 메타 정보들을 저장함\n메타정보에는 어느 chunk , 즉 어떤 data 가 어떤 shard 에 있는지, chunk 의 밸런싱 작업은 어떻게 해야할지 등의 메타정보와 사용자 인증 정보가 저장됨\n이렇게 중요한 정보들을 담고 있어서 가용성을 위해 하나의 replSet 으로 구성되어야 함\n config server 정보  repl_conf:PRIMARY\u0026gt; use config; switched to db config repl_conf:PRIMARY\u0026gt; show collections; actionlog changelog chunks collections databases lockpings locks migrations mongos shards system.","keywords":["mongodb"],"articleBody":" 지난 글에서 mongodb shard cluster 개념과 구성하는 방법에 대해 소개드렸고 이번 글에서는 구성요소 중 하나인 config server에 대해 다루겠습니다.\nConfig server 란? config server는 shard cluster에서 필요한 모든 메타 정보들을 저장함\n메타정보에는 어느 chunk , 즉 어떤 data 가 어떤 shard 에 있는지, chunk 의 밸런싱 작업은 어떻게 해야할지 등의 메타정보와 사용자 인증 정보가 저장됨\n이렇게 중요한 정보들을 담고 있어서 가용성을 위해 하나의 replSet 으로 구성되어야 함\n config server 정보  repl_conf:PRIMARY use config; switched to db config repl_conf:PRIMARY show collections; actionlog changelog chunks collections databases lockpings locks migrations mongos shards system.sessions tags transactions version  databases  repl_conf:PRIMARY db.databases.find() { \"_id\" : \"shard_test\", \"primary\" : \"repl_shard2\", \"partitioned\" : false, \"version\" : { \"uuid\" : UUID(\"a2a1b712-6070-44c5-9370-ae711e9018bd\"), \"lastMod\" : 1 } } { \"_id\" : \"test\", \"primary\" : \"repl_shard2\", \"partitioned\" : true, \"version\" : { \"uuid\" : UUID(\"5f6fa995-53c0-4677-a1ba-38aff579df77\"), \"lastMod\" : 1 } } = shard cluster 가 가지고 있는 데이터베이스의 목록\n“partitioned” : 샤딩 활성화 여부 의미\n collections  repl_conf:PRIMARY db.collections.find() { \"_id\" : \"test.testCollection2\", \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\"), \"lastmod\" : ISODate(\"1970-02-19T17:02:47.299Z\"), \"dropped\" : false, \"key\" : { \"_id\" : \"hashed\" }, \"unique\" : false, \"uuid\" : UUID(\"8cb727b3-81e2-4aff-a6a0-30b8f53240e4\") } = sharding 된 collection 정보\n“_id” : 데이터베이스 이름+컬렉션 이름\n“key” : 컬렉션의 샤딩 키\n chunks  mongos db.chunks.find() { \"_id\" : \"test.testCollection2-_id_4611686018427387902\", \"ns\" : \"test.testCollection2\", \"min\" : { \"_id\" : NumberLong(\"4611686018427387902\") }, \"max\" : { \"_id\" : { \"$maxKey\" : 1 } }, \"shard\" : \"repl_shard2\", \"lastmod\" : Timestamp(1, 3), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\"), \"history\" : [ { \"validAfter\" : Timestamp(1566738603, 6), \"shard\" : \"repl_shard2\" } ] } { \"_id\" : \"test.testCollection2-_id_MinKey\", \"ns\" : \"test.testCollection2\", \"min\" : { \"_id\" : { \"$minKey\" : 1 } }, \"max\" : { \"_id\" : NumberLong(\"-4611686018427387902\") }, \"shard\" : \"repl_shard1\", \"lastmod\" : Timestamp(1, 0), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\"), \"history\" : [ { \"validAfter\" : Timestamp(1566738603, 6), \"shard\" : \"repl_shard1\" } ] } { \"_id\" : \"test.testCollection2-_id_-4611686018427387902\", \"ns\" : \"test.testCollection2\", \"min\" : { \"_id\" : NumberLong(\"-4611686018427387902\") }, \"max\" : { \"_id\" : NumberLong(0) }, \"shard\" : \"repl_shard1\", \"lastmod\" : Timestamp(1, 1), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\"), \"history\" : [ { \"validAfter\" : Timestamp(1566738603, 6), \"shard\" : \"repl_shard1\" } ] } { \"_id\" : \"test.testCollection2-_id_0\", \"ns\" : \"test.testCollection2\", \"min\" : { \"_id\" : NumberLong(0) }, \"max\" : { \"_id\" : NumberLong(\"4611686018427387902\") }, \"shard\" : \"repl_shard2\", \"lastmod\" : Timestamp(1, 2), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\"), \"history\" : [ { \"validAfter\" : Timestamp(1566738603, 6), \"shard\" : \"repl_shard2\" } ] } = sharding 된 컬렉션의 모든 chunk 정보\n“_id” : database + collection + chunk가 갖는 값의 시작 값\n“shard” : 해당 chunk 가 속한 shard , 현재 각각 샤드에 두개씩의 chunk 가 존재함\n shards  repl_conf:PRIMARY db.shards.find() { \"_id\" : \"repl_shard1\", \"host\" : \"repl_shard1/mongo_shard1:27018,mongo_shard2:27018,mongo_shard3:27018\", \"state\" : 1 } { \"_id\" : \"repl_shard2\", \"host\" : \"repl_shard2/mongo_shard4:27018,mongo_shard5:27018,mongo_shard6:27018\", \"state\" : 1 } = shard cluster 내 등록된 모든 샤드 서버의 정보\n settings  { \"_id\" : \"chunksize\", \"value\" : 64 } { \"_id\" : \"balancer\", \"stopped\" : false } { \"_id\" : \"autosplit\", \"enabled\" : true } = chunk size , 밸런싱 관련 설정\n초기 환경에서 db.settings.find() 를 수행해도 조회되는 게 없는데 이는 관련 설정이 저장된게 없기 때문\n아래와 같이 save command 수행 후엔 조회 가능\nrepl_conf:PRIMARY db.settings.save ( {_id:\"chunksize\",value:64} ) WriteResult({ \"nMatched\" : 0, \"nUpserted\" : 1, \"nModified\" : 0, \"_id\" : \"chunksize\" }) repl_conf:PRIMARY db.settings.find() { \"_id\" : \"chunksize\", \"value\" : 64 } repl_conf:PRIMARY db.settings.save ( {_id:\"autosplit\",\"enabled\":false} ) WriteResult({ \"nMatched\" : 0, \"nUpserted\" : 1, \"nModified\" : 0, \"_id\" : \"autosplit\" })  = 위 설정은 mongos 의 sh.status() 와도 연동됨\nmongos sh.status() autosplit: Currently enabled: no   chunk balancing 수행 시간 설정하기  repl_conf:PRIMARY db.settings.update ( ... {_id:\"balancer\"}, ... {$set : {activeWindow: {start: \"02:00\", stop : \"06:00\" } } }, ... {upsert : true } ) WriteResult({ \"nMatched\" : 0, \"nUpserted\" : 1, \"nModified\" : 0, \"_id\" : \"balanver\" }) repl_conf:PRIMARY db.settings.find() { \"_id\" : \"chunksize\", \"value\" : 64 } { \"_id\" : \"balancer\", \"stopped\" : false } { \"_id\" : \"autosplit\", \"enabled\" : true } { \"_id\" : \"balanver\", \"activeWindow\" : { \"start\" : \"02:00\", \"stop\" : \"06:00\" } } = balancing 작업이 02:00 자동으로 수행되도록 설정\n locks   repl_conf:PRIMARY db.locks.find() { \"_id\" : \"config\", \"state\" : 0, \"process\" : \"ConfigServer\", \"ts\" : ObjectId(\"5d6b7f15a9f5ecd49052a36f\"), \"when\" : ISODate(\"2019-09-01T08:19:33.165Z\"), \"who\" : \"ConfigServer:conn164\", \"why\" : \"createCollection\" } { \"_id\" : \"config.system.sessions\", \"state\" : 0, \"process\" : \"ConfigServer\", \"ts\" : ObjectId(\"5d6b7f15a9f5ecd49052a376\"), \"when\" : ISODate(\"2019-09-01T08:19:33.172Z\"), \"who\" : \"ConfigServer:conn164\", \"why\" : \"createCollection\" } { \"_id\" : \"testdb\", \"state\" : 0, \"process\" : \"ConfigServer\", \"ts\" : ObjectId(\"5d62889d3ed72a6b6729a5ca\"), \"when\" : ISODate(\"2019-08-25T13:09:49.728Z\"), \"who\" : \"ConfigServer:conn24\", \"why\" : \"shardCollection\" } { \"_id\" : \"testdb.testCollection2\", \"state\" : 0, \"process\" : \"ConfigServer\", \"ts\" : ObjectId(\"5d62889d3ed72a6b6729a5d1\"), \"when\" : ISODate(\"2019-08-25T13:09:49.738Z\"), \"who\" : \"ConfigServer:conn24\", \"why\" : \"shardCollection\" } { \"_id\" : \"test.testCollection2\", \"state\" : 0, \"process\" : \"ConfigServer\", \"ts\" : ObjectId(\"5d6288ab3ed72a6b6729a65a\"), \"when\" : ISODate(\"2019-08-25T13:10:03.834Z\"), \"who\" : \"ConfigServer:conn24\", \"why\" : \"shardCollection\" } = shard cluster 내 여러개의 mongos 가 동시에 동일한 chunk에 대한 작업을 시도하는 등의 이슈를 방지하기 위해\n작업을 수행하기 전 config server 의 locks collection의 lock을 획득 후에만 작업할 수 있도록 함\n changelog  repl_conf:PRIMARY db.changelog.find() { \"_id\" : \"69c6ea3e5527:27019-2019-09-01T08:43:10.827+0000-5d6b849ea9f5ecd49052d3ad\", \"server\" : \"69c6ea3e5527:27019\", \"shard\" : \"config\", \"clientAddr\" : \"111.111.0.8:58938\", \"time\" : ISODate(\"2019-09-01T08:43:10.827Z\"), \"what\" : \"split\", \"ns\" : \"test.testCollection2\", \"details\" : { \"before\" : { \"min\" : { \"_id\" : NumberLong(\"-4611686018427387902\") }, \"max\" : { \"_id\" : NumberLong(0) }, \"lastmod\" : Timestamp(1, 3), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\") }, \"left\" : { \"min\" : { \"_id\" : NumberLong(\"-4611686018427387902\") }, \"max\" : { \"_id\" : NumberLong(\"-2315705090665887915\") }, \"lastmod\" : Timestamp(1, 4), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\") }, \"right\" : { \"min\" : { \"_id\" : NumberLong(\"-2315705090665887915\") }, \"max\" : { \"_id\" : NumberLong(0) }, \"lastmod\" : Timestamp(1, 5), \"lastmodEpoch\" : ObjectId(\"5d6288ab1a98ba4cb7e3aec2\") } } } = config 서버의 메타 정보 변경등이 기록됨\nex) db, collection 생성, chunk split , migration 등, 위는 split 로그\n changelog 에서 split 로그만 확인하는 법   repl_conf:PRIMARY db.changelog.find( {\"what\":{$in: [\"multi-split\",\"split\"]}}, {_id:0,what:1,ns:1,time:1}).sort({$natural:-1}).limit(5).pretty() { \"time\" : ISODate(\"2019-09-01T08:43:10.827Z\"), \"what\" : \"split\", \"ns\" : \"test.testCollection2\" } ","wordCount":"958","inLanguage":"en","datePublished":"2021-10-05T09:03:46+09:00","dateModified":"2021-10-05T09:03:46+09:00","author":{"@type":"Person","name":"kimdubi"},"mainEntityOfPage":{"@type":"WebPage","@id":"/mongodb/mongo_shard_cluster_configsvr/"},"publisher":{"@type":"Organization","name":"kimDuBiA","logo":{"@type":"ImageObject","url":"%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=/categories/ title=categories><span>categories</span></a></li><li><a href=/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href>Home</a>&nbsp;»&nbsp;<a href=/mongodb/>Mongodbs</a></div><h1 class=post-title>MongoDB Sharded Cluster - Config server</h1><div class=post-meta>October 5, 2021&nbsp;·&nbsp;5 min&nbsp;·&nbsp;kimdubi</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#config-server-%eb%9e%80 aria-label="Config server 란?">Config server 란?</a></li></ul></div></details></div><div class=post-content><hr><p>지난 글에서 mongodb shard cluster 개념과 구성하는 방법에 대해 소개드렸고  이번 글에서는 구성요소 중 하나인 config server에 대해 다루겠습니다.</p><h3 id=config-server-란>Config server 란?<a hidden class=anchor aria-hidden=true href=#config-server-란>#</a></h3><p>config server는 shard cluster에서 필요한 모든 메타 정보들을 저장함<br>메타정보에는 어느 chunk , 즉 어떤 data 가 어떤 shard 에 있는지, chunk 의 밸런싱 작업은 어떻게 해야할지 등의 메타정보와 사용자 인증 정보가 저장됨<br>이렇게 중요한 정보들을 담고 있어서 가용성을 위해 하나의 replSet 으로 구성되어야 함</p><ul><li>config server 정보</li></ul><pre><code>repl_conf:PRIMARY&gt; use config;
switched to db config

repl_conf:PRIMARY&gt; show collections;
actionlog
changelog
chunks
collections
databases
lockpings
locks
migrations
mongos
shards
system.sessions
tags
transactions
version 
</code></pre><ul><li>databases</li></ul><pre><code>repl_conf:PRIMARY&gt; db.databases.find()
{ &quot;_id&quot; : &quot;shard_test&quot;, &quot;primary&quot; : &quot;repl_shard2&quot;, &quot;partitioned&quot; : false, &quot;version&quot; : { &quot;uuid&quot; : UUID(&quot;a2a1b712-6070-44c5-9370-ae711e9018bd&quot;), &quot;lastMod&quot; : 1 } }

{ &quot;_id&quot; : &quot;test&quot;, &quot;primary&quot; : &quot;repl_shard2&quot;, &quot;partitioned&quot; : true, &quot;version&quot; : { &quot;uuid&quot; : UUID(&quot;5f6fa995-53c0-4677-a1ba-38aff579df77&quot;), &quot;lastMod&quot; : 1 } }
</code></pre><p>=> shard cluster 가 가지고 있는 데이터베이스의 목록<br>“partitioned” : 샤딩 활성화 여부 의미</p><ul><li>collections</li></ul><pre><code>repl_conf:PRIMARY&gt; db.collections.find()

{ &quot;_id&quot; : &quot;test.testCollection2&quot;, &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;), &quot;lastmod&quot; : ISODate(&quot;1970-02-19T17:02:47.299Z&quot;), &quot;dropped&quot; : false, &quot;key&quot; : { &quot;_id&quot; : &quot;hashed&quot; }, &quot;unique&quot; : false, &quot;uuid&quot; : UUID(&quot;8cb727b3-81e2-4aff-a6a0-30b8f53240e4&quot;) }
</code></pre><p>=> sharding 된 collection 정보<br>“_id” : 데이터베이스 이름+컬렉션 이름<br>“key” : 컬렉션의 샤딩 키</p><ul><li>chunks</li></ul><pre><code>mongos&gt; db.chunks.find()

{ &quot;_id&quot; : &quot;test.testCollection2-_id_4611686018427387902&quot;, &quot;ns&quot; : &quot;test.testCollection2&quot;, &quot;min&quot; : { &quot;_id&quot; : NumberLong(&quot;4611686018427387902&quot;) }, &quot;max&quot; : { &quot;_id&quot; : { &quot;$maxKey&quot; : 1 } }, &quot;shard&quot; : &quot;repl_shard2&quot;, &quot;lastmod&quot; : Timestamp(1, 3), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;), &quot;history&quot; : [ { &quot;validAfter&quot; : Timestamp(1566738603, 6), &quot;shard&quot; : &quot;repl_shard2&quot; } ] }

{ &quot;_id&quot; : &quot;test.testCollection2-_id_MinKey&quot;, &quot;ns&quot; : &quot;test.testCollection2&quot;, &quot;min&quot; : { &quot;_id&quot; : { &quot;$minKey&quot; : 1 } }, &quot;max&quot; : { &quot;_id&quot; : NumberLong(&quot;-4611686018427387902&quot;) }, &quot;shard&quot; : &quot;repl_shard1&quot;, &quot;lastmod&quot; : Timestamp(1, 0), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;), &quot;history&quot; : [ { &quot;validAfter&quot; : Timestamp(1566738603, 6), &quot;shard&quot; : &quot;repl_shard1&quot; } ] }

{ &quot;_id&quot; : &quot;test.testCollection2-_id_-4611686018427387902&quot;, &quot;ns&quot; : &quot;test.testCollection2&quot;, &quot;min&quot; : { &quot;_id&quot; : NumberLong(&quot;-4611686018427387902&quot;) }, &quot;max&quot; : { &quot;_id&quot; : NumberLong(0) }, &quot;shard&quot; : &quot;repl_shard1&quot;, &quot;lastmod&quot; : Timestamp(1, 1), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;), &quot;history&quot; : [ { &quot;validAfter&quot; : Timestamp(1566738603, 6), &quot;shard&quot; : &quot;repl_shard1&quot; } ] }

{ &quot;_id&quot; : &quot;test.testCollection2-_id_0&quot;, &quot;ns&quot; : &quot;test.testCollection2&quot;, &quot;min&quot; : { &quot;_id&quot; : NumberLong(0) }, &quot;max&quot; : { &quot;_id&quot; : NumberLong(&quot;4611686018427387902&quot;) }, &quot;shard&quot; : &quot;repl_shard2&quot;, &quot;lastmod&quot; : Timestamp(1, 2), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;), &quot;history&quot; : [ { &quot;validAfter&quot; : Timestamp(1566738603, 6), &quot;shard&quot; : &quot;repl_shard2&quot; } ] }
</code></pre><p>=> sharding 된 컬렉션의 모든 chunk 정보<br>“_id” : database + collection + chunk가 갖는 값의 시작 값<br>“shard” : 해당 chunk 가 속한 shard , 현재 각각 샤드에 두개씩의 chunk 가 존재함</p><ul><li>shards</li></ul><pre><code>repl_conf:PRIMARY&gt; db.shards.find()

{ &quot;_id&quot; : &quot;repl_shard1&quot;, &quot;host&quot; : &quot;repl_shard1/mongo_shard1:27018,mongo_shard2:27018,mongo_shard3:27018&quot;, &quot;state&quot; : 1 }
{ &quot;_id&quot; : &quot;repl_shard2&quot;, &quot;host&quot; : &quot;repl_shard2/mongo_shard4:27018,mongo_shard5:27018,mongo_shard6:27018&quot;, &quot;state&quot; : 1 }
</code></pre><p>=> shard cluster 내 등록된 모든 샤드 서버의 정보</p><ul><li>settings</li></ul><pre><code>{ &quot;_id&quot; : &quot;chunksize&quot;, &quot;value&quot; : 64 }
{ &quot;_id&quot; : &quot;balancer&quot;, &quot;stopped&quot; : false }
{ &quot;_id&quot; : &quot;autosplit&quot;, &quot;enabled&quot; : true }
</code></pre><p>=> chunk size , 밸런싱 관련 설정<br>초기 환경에서 db.settings.find() 를 수행해도 조회되는 게 없는데 이는 관련 설정이 저장된게 없기 때문<br>아래와 같이 save command 수행 후엔 조회 가능</p><pre><code>repl_conf:PRIMARY&gt; db.settings.save ( {_id:&quot;chunksize&quot;,value:64} )
WriteResult({ &quot;nMatched&quot; : 0, &quot;nUpserted&quot; : 1, &quot;nModified&quot; : 0, &quot;_id&quot; : &quot;chunksize&quot; })

repl_conf:PRIMARY&gt; db.settings.find()
{ &quot;_id&quot; : &quot;chunksize&quot;, &quot;value&quot; : 64 }

repl_conf:PRIMARY&gt; db.settings.save ( {_id:&quot;autosplit&quot;,&quot;enabled&quot;:false} )

WriteResult({ &quot;nMatched&quot; : 0, &quot;nUpserted&quot; : 1, &quot;nModified&quot; : 0, &quot;_id&quot; : &quot;autosplit&quot; })
</code></pre><p>=> 위 설정은 mongos 의 sh.status() 와도 연동됨</p><pre><code>mongos&gt; sh.status()

  autosplit:    
Currently enabled: no
</code></pre><ul><li>chunk balancing 수행 시간 설정하기</li></ul><pre><code>repl_conf:PRIMARY&gt; db.settings.update (
... {_id:&quot;balancer&quot;},
... {$set : {activeWindow: {start: &quot;02:00&quot;, stop : &quot;06:00&quot; } } },
... {upsert : true } )

WriteResult({ &quot;nMatched&quot; : 0, &quot;nUpserted&quot; : 1, &quot;nModified&quot; : 0, &quot;_id&quot; : &quot;balanver&quot; })

repl_conf:PRIMARY&gt; db.settings.find()
{ &quot;_id&quot; : &quot;chunksize&quot;, &quot;value&quot; : 64 }
{ &quot;_id&quot; : &quot;balancer&quot;, &quot;stopped&quot; : false }
{ &quot;_id&quot; : &quot;autosplit&quot;, &quot;enabled&quot; : true }
{ &quot;_id&quot; : &quot;balanver&quot;, &quot;activeWindow&quot; : { &quot;start&quot; : &quot;02:00&quot;, &quot;stop&quot; : &quot;06:00&quot; } }
</code></pre><p>=> balancing 작업이 02:00 자동으로 수행되도록 설정</p><ul><li>locks </li></ul><pre><code>repl_conf:PRIMARY&gt; db.locks.find()

{ &quot;_id&quot; : &quot;config&quot;, &quot;state&quot; : 0, &quot;process&quot; : &quot;ConfigServer&quot;, &quot;ts&quot; : ObjectId(&quot;5d6b7f15a9f5ecd49052a36f&quot;), &quot;when&quot; : ISODate(&quot;2019-09-01T08:19:33.165Z&quot;), &quot;who&quot; : &quot;ConfigServer:conn164&quot;, &quot;why&quot; : &quot;createCollection&quot; }

{ &quot;_id&quot; : &quot;config.system.sessions&quot;, &quot;state&quot; : 0, &quot;process&quot; : &quot;ConfigServer&quot;, &quot;ts&quot; : ObjectId(&quot;5d6b7f15a9f5ecd49052a376&quot;), &quot;when&quot; : ISODate(&quot;2019-09-01T08:19:33.172Z&quot;), &quot;who&quot; : &quot;ConfigServer:conn164&quot;, &quot;why&quot; : &quot;createCollection&quot; }

{ &quot;_id&quot; : &quot;testdb&quot;, &quot;state&quot; : 0, &quot;process&quot; : &quot;ConfigServer&quot;, &quot;ts&quot; : ObjectId(&quot;5d62889d3ed72a6b6729a5ca&quot;), &quot;when&quot; : ISODate(&quot;2019-08-25T13:09:49.728Z&quot;), &quot;who&quot; : &quot;ConfigServer:conn24&quot;, &quot;why&quot; : &quot;shardCollection&quot; }

{ &quot;_id&quot; : &quot;testdb.testCollection2&quot;, &quot;state&quot; : 0, &quot;process&quot; : &quot;ConfigServer&quot;, &quot;ts&quot; : ObjectId(&quot;5d62889d3ed72a6b6729a5d1&quot;), &quot;when&quot; : ISODate(&quot;2019-08-25T13:09:49.738Z&quot;), &quot;who&quot; : &quot;ConfigServer:conn24&quot;, &quot;why&quot; : &quot;shardCollection&quot; }

{ &quot;_id&quot; : &quot;test.testCollection2&quot;, &quot;state&quot; : 0, &quot;process&quot; : &quot;ConfigServer&quot;, &quot;ts&quot; : ObjectId(&quot;5d6288ab3ed72a6b6729a65a&quot;), &quot;when&quot; : ISODate(&quot;2019-08-25T13:10:03.834Z&quot;), &quot;who&quot; : &quot;ConfigServer:conn24&quot;, &quot;why&quot; : &quot;shardCollection&quot; }
</code></pre><p>=> shard cluster 내 여러개의 mongos 가 동시에 동일한 chunk에 대한 작업을 시도하는 등의 이슈를 방지하기 위해<br>작업을 수행하기 전 config server 의 locks collection의 lock을 획득 후에만 작업할 수 있도록 함</p><ul><li>changelog</li></ul><pre><code>repl_conf:PRIMARY&gt; db.changelog.find()

{ &quot;_id&quot; : &quot;69c6ea3e5527:27019-2019-09-01T08:43:10.827+0000-5d6b849ea9f5ecd49052d3ad&quot;, &quot;server&quot; : &quot;69c6ea3e5527:27019&quot;, &quot;shard&quot; : &quot;config&quot;, &quot;clientAddr&quot; : &quot;111.111.0.8:58938&quot;, &quot;time&quot; : ISODate(&quot;2019-09-01T08:43:10.827Z&quot;), 
&quot;what&quot; : &quot;split&quot;, &quot;ns&quot; : &quot;test.testCollection2&quot;, 
&quot;details&quot; : { &quot;before&quot; : { &quot;min&quot; : { &quot;_id&quot; : NumberLong(&quot;-4611686018427387902&quot;) }, &quot;max&quot; : { &quot;_id&quot; : NumberLong(0) }, &quot;lastmod&quot; : Timestamp(1, 3), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;) }, &quot;left&quot; : { &quot;min&quot; : { &quot;_id&quot; : NumberLong(&quot;-4611686018427387902&quot;) }, &quot;max&quot; : { &quot;_id&quot; : NumberLong(&quot;-2315705090665887915&quot;) }, &quot;lastmod&quot; : Timestamp(1, 4), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;) }, &quot;right&quot; : { &quot;min&quot; : { &quot;_id&quot; : NumberLong(&quot;-2315705090665887915&quot;) }, &quot;max&quot; : { &quot;_id&quot; : NumberLong(0) }, &quot;lastmod&quot; : Timestamp(1, 5), &quot;lastmodEpoch&quot; : ObjectId(&quot;5d6288ab1a98ba4cb7e3aec2&quot;) } } }
</code></pre><p>=> config 서버의 메타 정보 변경등이 기록됨<br>ex) db, collection 생성, chunk split , migration 등,  위는 split 로그</p><ul><li>changelog 에서 split 로그만 확인하는 법 </li></ul><pre><code>repl_conf:PRIMARY&gt; db.changelog.find( {&quot;what&quot;:{$in: [&quot;multi-split&quot;,&quot;split&quot;]}}, {_id:0,what:1,ns:1,time:1}).sort({$natural:-1}).limit(5).pretty()
{
&quot;time&quot; : ISODate(&quot;2019-09-01T08:43:10.827Z&quot;),
&quot;what&quot; : &quot;split&quot;,
&quot;ns&quot; : &quot;test.testCollection2&quot; 
}
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=/tags/mongodb/>mongodb</a></li></ul></footer><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='disqus_nLxot7hRj6';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2021 <a href>kimDuBiA</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerText='copy';function copyingDone(){copybutton.innerText='copied!';setTimeout(()=>{copybutton.innerText='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>
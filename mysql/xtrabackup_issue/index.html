<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Xtrabackup long transaction issue | kimDuBiA</title><meta name=keywords content="mysql,xtrabackup,운영,issue"><meta name=description content="Xtrabackup 사용 시 주의사항 Xtrabackup 은 mysqldump 대신 많이 사용되는 오픈소스 hotbackup utility 입니다.
널리 사용되는 유틸리티라서 사용하는데에 큰 이슈는 없지만 다만 사용할 때 꼭 기억해둬야할 주의점이 있습니다.
Xtrabackup은 백업 수행이후 FLUSH TABLES WITH READ LOCK을 수행하는데 이 때 실행되는 쿼리가 있는 경우 flush 구문은 테이블락을 획득하지 못하고 waiting하며
lockwait timeout 이후 세션이 종료되어 백업이 완료되지 못하거나 backup이 비정상적으로 길어지는 현상이 발생할 수 있다는 점입니다.
백업서버에서 롱 쿼리 수행 mysql> select a,b,c,count(*) from tb_test group by a,b,c order by a,b,c desc ;  동시에 xtrabackup 수행 [testuser ]$ innobackupex --defaults-file=/home1/testuser/db/mysql/my."><meta name=author content="kimdubi"><link rel=canonical href=/mysql/xtrabackup_issue/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.2dbef8664bbfb3e83a0a44fd4a8fc5010240dbcd1dbc1400753b928b497b8f5e.css integrity="sha256-Lb74Zku/s+g6CkT9So/FAQJA280dvBQAdTuSi0l7j14=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-123-45','auto');ga('send','pageview');}</script><meta property="og:title" content="Xtrabackup long transaction issue"><meta property="og:description" content="Xtrabackup 사용 시 주의사항 Xtrabackup 은 mysqldump 대신 많이 사용되는 오픈소스 hotbackup utility 입니다.
널리 사용되는 유틸리티라서 사용하는데에 큰 이슈는 없지만 다만 사용할 때 꼭 기억해둬야할 주의점이 있습니다.
Xtrabackup은 백업 수행이후 FLUSH TABLES WITH READ LOCK을 수행하는데 이 때 실행되는 쿼리가 있는 경우 flush 구문은 테이블락을 획득하지 못하고 waiting하며
lockwait timeout 이후 세션이 종료되어 백업이 완료되지 못하거나 backup이 비정상적으로 길어지는 현상이 발생할 수 있다는 점입니다.
백업서버에서 롱 쿼리 수행 mysql> select a,b,c,count(*) from tb_test group by a,b,c order by a,b,c desc ;  동시에 xtrabackup 수행 [testuser ]$ innobackupex --defaults-file=/home1/testuser/db/mysql/my."><meta property="og:type" content="article"><meta property="og:url" content="/mysql/xtrabackup_issue/"><meta property="og:image" content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="mysql"><meta property="article:published_time" content="2021-10-04T21:00:38+09:00"><meta property="article:modified_time" content="2021-10-04T21:00:38+09:00"><meta property="og:site_name" content="kimDuBiA"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Xtrabackup long transaction issue"><meta name=twitter:description content="Xtrabackup 사용 시 주의사항 Xtrabackup 은 mysqldump 대신 많이 사용되는 오픈소스 hotbackup utility 입니다.
널리 사용되는 유틸리티라서 사용하는데에 큰 이슈는 없지만 다만 사용할 때 꼭 기억해둬야할 주의점이 있습니다.
Xtrabackup은 백업 수행이후 FLUSH TABLES WITH READ LOCK을 수행하는데 이 때 실행되는 쿼리가 있는 경우 flush 구문은 테이블락을 획득하지 못하고 waiting하며
lockwait timeout 이후 세션이 종료되어 백업이 완료되지 못하거나 backup이 비정상적으로 길어지는 현상이 발생할 수 있다는 점입니다.
백업서버에서 롱 쿼리 수행 mysql> select a,b,c,count(*) from tb_test group by a,b,c order by a,b,c desc ;  동시에 xtrabackup 수행 [testuser ]$ innobackupex --defaults-file=/home1/testuser/db/mysql/my."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Mysqls","item":"/mysql/"},{"@type":"ListItem","position":3,"name":"Xtrabackup long transaction issue","item":"/mysql/xtrabackup_issue/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Xtrabackup long transaction issue","name":"Xtrabackup long transaction issue","description":"Xtrabackup 사용 시 주의사항 Xtrabackup 은 mysqldump 대신 많이 사용되는 오픈소스 hotbackup utility 입니다.\n널리 사용되는 유틸리티라서 사용하는데에 큰 이슈는 없지만 다만 사용할 때 꼭 기억해둬야할 주의점이 있습니다.\nXtrabackup은 백업 수행이후 FLUSH TABLES WITH READ LOCK을 수행하는데 이 때 실행되는 쿼리가 있는 경우 flush 구문은 테이블락을 획득하지 못하고 waiting하며\nlockwait timeout 이후 세션이 종료되어 백업이 완료되지 못하거나 backup이 비정상적으로 길어지는 현상이 발생할 수 있다는 점입니다.\n백업서버에서 롱 쿼리 수행 mysql\u0026gt; select a,b,c,count(*) from tb_test group by a,b,c order by a,b,c desc ;  동시에 xtrabackup 수행 [testuser ]$ innobackupex --defaults-file=/home1/testuser/db/mysql/my.","keywords":["mysql","xtrabackup","운영","issue"],"articleBody":"Xtrabackup 사용 시 주의사항 Xtrabackup 은 mysqldump 대신 많이 사용되는 오픈소스 hotbackup utility 입니다.\n널리 사용되는 유틸리티라서 사용하는데에 큰 이슈는 없지만 다만 사용할 때 꼭 기억해둬야할 주의점이 있습니다.\nXtrabackup은 백업 수행이후 FLUSH TABLES WITH READ LOCK을 수행하는데 이 때 실행되는 쿼리가 있는 경우 flush 구문은 테이블락을 획득하지 못하고 waiting하며\nlockwait timeout 이후 세션이 종료되어 백업이 완료되지 못하거나 backup이 비정상적으로 길어지는 현상이 발생할 수 있다는 점입니다.\n백업서버에서 롱 쿼리 수행 mysql select a,b,c,count(*) from tb_test group by a,b,c order by a,b,c desc ;  동시에 xtrabackup 수행 [testuser ]$ innobackupex --defaults-file=/home1/testuser/db/mysql/my.cnf --user bk_user --password test --socket /home1/testuser/db/mysql/tmp/mysql.sock --slave-info --backup . . . . xtrabackup: Generating a list of tablespaces InnoDB: Allocated tablespace ID 21 for sys/sys_config, old maximum was 0 201213 15:39:24 [01] Copying ./ibdata1 to /home1/testuser/bk_Test/2020-12-13_15-39-23/ibdata1 201213 15:39:24  log scanned up to (2905973944) 201213 15:39:25  log scanned up to (2905973944) 201213 15:39:26 [01] ...done 201213 15:39:26 [01] Copying ./sys/sys_config.ibd to /home1/testuser/bk_Test/2020-12-13_15-39-23/sys/sys_config.ibd . . . 201213 15:39:35  log scanned up to (2905973944) 201213 15:39:36 Executing FLUSH NO_WRITE_TO_BINLOG TABLES... 201213 15:39:36  log scanned up to (2905973944) 201213 15:39:37  log scanned up to (2905973944) 201213 15:39:38  log scanned up to (2905973944) 201213 15:39:39  log scanned up to (2905973944) 201213 15:39:40  log scanned up to (2905973944) 201213 15:39:41  log scanned up to (2905973944) 201213 15:39:42  log scanned up to (2905973944) 201213 15:39:43  log scanned up to (2905973944) 201213 15:39:44  log scanned up to (2905973944) 201213 15:39:45  log scanned up to (2905973944) 201213 15:39:46  log scanned up to (2905973944) 201213 15:39:47  log scanned up to (2905973944) . . .  = Xtrabacup은 innodb 테이블의 ibd 파일을 copy 한 후 MyIsam 같은 transaction을 지원하지 않는 테이블들의 백업을 위해 Executing FLUSH NO_WRITE_TO_BINLOG TABLES… 즉 flush tables with read lock을 수행합니다.\n이때 long query가 돌고 있다면 flush table with read lock을 걸지 못하고 아래와 같이 lock 대기하게 됩니다.\n문제는 ‘Waiting for table flush’ 으로 인해 뒤이어 들어오는 모든 쿼리들이 전부 대기하게 된다는 점인데\nsingle instance에서 백업을 돌렸는데 이런 현상이 발생하게 되면 그대로 서비스 장애로 연결되는 이슈가 있습니다.\nmysql show processlist; +------+-------------+-----------+---------------+---------+------+--------------------------------------------------------+----------------------------------------------------------------------------+ | Id | User | Host | db | Command | Time | State | Info | +------+-------------+-----------+---------------+---------+------+--------------------------------------------------------+----------------------------------------------------------------------------+ | 1250 | admin | localhost | repltest_1029 | Query | 51 | Creating sort index | select a,b,c,count(*) from tb_test group by a,b,c order by a,b desc ,c asc | | 2476 | admin | localhost | repltest_1029 | Query | 0 | starting | show processlist | | 2485 | bk_user | localhost | NULL | Query | 38 | Waiting for table flush | FLUSH NO_WRITE_TO_BINLOG TABLES | | 2488 | admin | localhost | repltest_1029 | Query | 20 | Waiting for table flush | select * from tb_test limit 1 | +------+-------------+-----------+---------------+---------+------+--------------------------------------------------------+----------------------------------------------------------------------------+  심지어 Xtrabackup 수행 시 자체적으로 lock_wait_timeout=31536000 으로 설정하고 돌기 때문에 DB 설정이 몇초간에 백업이 취소되지 않고 비정상적으로 길어질 수 있습니다.\n2020-12-13T06:49:03.391760Z 2182 Query SET SESSION lock_wait_timeout=31536000 2020-12-13T06:49:03.391876Z 2182 Query FLUSH NO_WRITE_TO_BINLOG TABLES  대응방안  백업 전용 Slave 구성하기 –ftwrl-wait-timeout , –ftwrl-wait-threshold = flush tables with read lock 커맨드를 실행하기 전에 wait하는 시간을 설정하는 옵션, –ftwrl-wait-timeout default=0, ftwrl을 바로 수행함\nFTWRL을 실행 하기 전에 –ftwrl-wait-timeout = 30 만큼 기다렸는데도 –ftwrl-wait-threshold(default 60)에 설정된 시간 보다 더 오래 실행되는 쿼리가 있으면 백업을 취소시켜 lock 대기로 인한 이슈를 최소화 시킴  201213 16:16:52 Waiting 30 seconds for queries running longer than 60 seconds to finish 201213 16:16:52 Executing FLUSH TABLES WITH READ LOCK... ftwrl 을 수행하기 전에 –ftwrl-wait-threshold 만큼의 long query 가 없어서 ftwrl 을 수행했는데 –ftwrl-wait-threshold 미만의 롱 쿼리로 인해 락 대기할 수 있음\n= –ftwrl-wait-threshold=0 으로 설정하면 됨\n –kill-long-queries-timeout , –kill-long-query-type\n= flush tables with read lock 수행 후 global lock 획득을 방해하는 쿼리를 kill 하는 옵션\n–kill-long-query-type 옵션을 통해 select , 혹은 모든 쿼리를 지정할 수 있음  innobackupex --ftwrl-wait-threshold=60 --ftrwl-wait-query-type=all \\ --ftrwl-wait-timeout=60 --kill-long-queries=30 \\ --kill-long-query-type=all = 60초이상 수행되는 모든 쿼리에 대해 60초이상 기다리지 않고 (남아있으면 백업 취소) ftwrl을 수행하고 30초 이내 ftwrl 락을 얻지 못하면 그 이전에 수행된 쿼리들을 모두 kill하겠다는 의미\n MySQL 8.0 \u0026 Xtrabackup 8.0 사용 시 InnoDB만 사용한다면 –no-lock 옵션이 자동적용 되어 FTWRL을 수행하지 않습니다.\n다만, –slave-info 옵션이 주어질 땐 binlog position 정보를 위해 마찬가지로 FTWRL이 수행됩니다.  ","wordCount":"688","inLanguage":"en","datePublished":"2021-10-04T21:00:38+09:00","dateModified":"2021-10-04T21:00:38+09:00","author":{"@type":"Person","name":"kimdubi"},"mainEntityOfPage":{"@type":"WebPage","@id":"/mysql/xtrabackup_issue/"},"publisher":{"@type":"Organization","name":"kimDuBiA","logo":{"@type":"ImageObject","url":"%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href accesskey=h title="Hi (Alt + H)">Hi</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=/ title=Home><span>Home</span></a></li><li><a href=/categories/ title=categories><span>categories</span></a></li><li><a href=/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href>Home</a>&nbsp;»&nbsp;<a href=/mysql/>Mysqls</a></div><h1 class=post-title>Xtrabackup long transaction issue</h1><div class=post-meta>October 4, 2021&nbsp;·&nbsp;4 min&nbsp;·&nbsp;kimdubi</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#xtrabackup-%ec%82%ac%ec%9a%a9-%ec%8b%9c-%ec%a3%bc%ec%9d%98%ec%82%ac%ed%95%ad aria-label="Xtrabackup 사용 시 주의사항">Xtrabackup 사용 시 주의사항</a><ul><li><a href=#%eb%b0%b1%ec%97%85%ec%84%9c%eb%b2%84%ec%97%90%ec%84%9c-%eb%a1%b1-%ec%bf%bc%eb%a6%ac-%ec%88%98%ed%96%89 aria-label="백업서버에서 롱 쿼리 수행">백업서버에서 롱 쿼리 수행</a></li><li><a href=#%eb%8f%99%ec%8b%9c%ec%97%90-xtrabackup-%ec%88%98%ed%96%89 aria-label="동시에 xtrabackup 수행">동시에 xtrabackup 수행</a></li><li><a href=#%eb%8c%80%ec%9d%91%eb%b0%a9%ec%95%88 aria-label=대응방안>대응방안</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=xtrabackup-사용-시-주의사항>Xtrabackup 사용 시 주의사항<a hidden class=anchor aria-hidden=true href=#xtrabackup-사용-시-주의사항>#</a></h2><p>Xtrabackup 은 mysqldump 대신 많이 사용되는 오픈소스 hotbackup utility 입니다.<br>널리 사용되는 유틸리티라서 사용하는데에 큰 이슈는 없지만 다만 사용할 때 꼭 기억해둬야할 주의점이 있습니다.<br>Xtrabackup은 백업 수행이후 FLUSH TABLES WITH READ LOCK을 수행하는데 이 때 실행되는 쿼리가 있는 경우 flush 구문은 테이블락을 획득하지 못하고 waiting하며<br>lockwait timeout 이후 세션이 종료되어 백업이 완료되지 못하거나 backup이 비정상적으로 길어지는 현상이 발생할 수 있다는 점입니다.</p><h3 id=백업서버에서-롱-쿼리-수행>백업서버에서 롱 쿼리 수행<a hidden class=anchor aria-hidden=true href=#백업서버에서-롱-쿼리-수행>#</a></h3><pre><code>mysql&gt; select a,b,c,count(*) from tb_test group by a,b,c order by a,b,c desc ;
</code></pre><h3 id=동시에-xtrabackup-수행>동시에 xtrabackup 수행<a hidden class=anchor aria-hidden=true href=#동시에-xtrabackup-수행>#</a></h3><pre><code>[testuser ]$ innobackupex --defaults-file=/home1/testuser/db/mysql/my.cnf --user bk_user --password test --socket /home1/testuser/db/mysql/tmp/mysql.sock --slave-info --backup .
.
.
.
xtrabackup: Generating a list of tablespaces
InnoDB: Allocated tablespace ID 21 for sys/sys_config, old maximum was 0
201213 15:39:24 [01] Copying ./ibdata1 to /home1/testuser/bk_Test/2020-12-13_15-39-23/ibdata1
201213 15:39:24 &gt;&gt; log scanned up to (2905973944)


201213 15:39:25 &gt;&gt; log scanned up to (2905973944)
201213 15:39:26 [01]        ...done
201213 15:39:26 [01] Copying ./sys/sys_config.ibd to /home1/testuser/bk_Test/2020-12-13_15-39-23/sys/sys_config.ibd
.
.
.
201213 15:39:35 &gt;&gt; log scanned up to (2905973944)
201213 15:39:36 Executing FLUSH NO_WRITE_TO_BINLOG TABLES...
201213 15:39:36 &gt;&gt; log scanned up to (2905973944)
201213 15:39:37 &gt;&gt; log scanned up to (2905973944)
201213 15:39:38 &gt;&gt; log scanned up to (2905973944)
201213 15:39:39 &gt;&gt; log scanned up to (2905973944)
201213 15:39:40 &gt;&gt; log scanned up to (2905973944)
201213 15:39:41 &gt;&gt; log scanned up to (2905973944)
201213 15:39:42 &gt;&gt; log scanned up to (2905973944)
201213 15:39:43 &gt;&gt; log scanned up to (2905973944)
201213 15:39:44 &gt;&gt; log scanned up to (2905973944)
201213 15:39:45 &gt;&gt; log scanned up to (2905973944)
201213 15:39:46 &gt;&gt; log scanned up to (2905973944)
201213 15:39:47 &gt;&gt; log scanned up to (2905973944)
.
.
.
</code></pre><p>=> Xtrabacup은 innodb 테이블의 ibd 파일을 copy 한 후 MyIsam 같은 transaction을 지원하지 않는 테이블들의 백업을 위해 Executing FLUSH NO_WRITE_TO_BINLOG TABLES… 즉 flush tables with read lock을 수행합니다.<br>이때 long query가 돌고 있다면 flush table with read lock을 걸지 못하고 아래와 같이 lock 대기하게 됩니다.</p><p>문제는 ‘Waiting for table flush’ 으로 인해 뒤이어 들어오는 모든 쿼리들이 전부 대기하게 된다는 점인데<br>single instance에서 백업을 돌렸는데 이런 현상이 발생하게 되면 그대로 서비스 장애로 연결되는 이슈가 있습니다.</p><pre><code>mysql&gt; show processlist;
+------+-------------+-----------+---------------+---------+------+--------------------------------------------------------+----------------------------------------------------------------------------+
| Id   | User        | Host      | db            | Command | Time | State                                                  | Info                                                                       |
+------+-------------+-----------+---------------+---------+------+--------------------------------------------------------+----------------------------------------------------------------------------+
| 1250 | admin       | localhost | repltest_1029 | Query   |   51 | Creating sort index                                    | select a,b,c,count(*) from tb_test group by a,b,c order by a,b desc ,c asc |
| 2476 | admin       | localhost | repltest_1029 | Query   |    0 | starting                                               | show processlist                                                           |
| 2485 | bk_user     | localhost | NULL          | Query   |   38 | Waiting for table flush                                | FLUSH NO_WRITE_TO_BINLOG TABLES                                            |
| 2488 | admin       | localhost | repltest_1029 | Query   |   20 | Waiting for table flush                                | select * from tb_test limit 1                                              |
+------+-------------+-----------+---------------+---------+------+--------------------------------------------------------+----------------------------------------------------------------------------+
</code></pre><p>심지어 Xtrabackup 수행 시 자체적으로 lock_wait_timeout=31536000 으로 설정하고 돌기 때문에 DB 설정이 몇초간에 백업이 취소되지 않고 비정상적으로 길어질 수 있습니다.</p><pre><code>2020-12-13T06:49:03.391760Z      2182 Query     SET SESSION lock_wait_timeout=31536000
2020-12-13T06:49:03.391876Z      2182 Query     FLUSH NO_WRITE_TO_BINLOG TABLES
</code></pre><h3 id=대응방안>대응방안<a hidden class=anchor aria-hidden=true href=#대응방안>#</a></h3><ul><li>백업 전용 Slave 구성하기</li><li>–ftwrl-wait-timeout , –ftwrl-wait-threshold => flush tables with read lock 커맨드를 실행하기 전에 wait하는 시간을 설정하는 옵션, –ftwrl-wait-timeout default=0, ftwrl을 바로 수행함<br>FTWRL을 실행 하기 전에 –ftwrl-wait-timeout = 30 만큼 기다렸는데도 –ftwrl-wait-threshold(default 60)에 설정된 시간 보다 더 오래 실행되는 쿼리가 있으면 백업을 취소시켜 lock 대기로 인한 이슈를 최소화 시킴</li></ul><pre><code>201213 16:16:52 Waiting 30 seconds for queries running longer than 60 seconds to finish
201213 16:16:52 Executing FLUSH TABLES WITH READ LOCK...
</code></pre><p>ftwrl 을 수행하기 전에 –ftwrl-wait-threshold 만큼의 long query 가 없어서 ftwrl 을 수행했는데 –ftwrl-wait-threshold 미만의 롱 쿼리로 인해 락 대기할 수 있음<br>=> –ftwrl-wait-threshold=0 으로 설정하면 됨</p><ul><li>–kill-long-queries-timeout , –kill-long-query-type<br>=> flush tables with read lock 수행 후 global lock 획득을 방해하는 쿼리를 kill 하는 옵션<br>–kill-long-query-type 옵션을 통해 select , 혹은 모든 쿼리를 지정할 수 있음</li></ul><pre><code>innobackupex --ftwrl-wait-threshold=60 --ftrwl-wait-query-type=all \
    --ftrwl-wait-timeout=60 --kill-long-queries=30 \ 
    --kill-long-query-type=all 
</code></pre><p>=> 60초이상 수행되는 모든 쿼리에 대해 60초이상 기다리지 않고 (남아있으면 백업 취소) ftwrl을 수행하고 30초 이내 ftwrl 락을 얻지 못하면 그 이전에 수행된 쿼리들을 모두 kill하겠다는 의미</p><ul><li>MySQL 8.0 & Xtrabackup 8.0 사용 시 InnoDB만 사용한다면 –no-lock 옵션이 자동적용 되어 FTWRL을 수행하지 않습니다.<br>다만, –slave-info 옵션이 주어질 땐 binlog position 정보를 위해 마찬가지로 FTWRL이 수행됩니다.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=/tags/mysql/>mysql</a></li><li><a href=/tags/xtrabackup/>xtrabackup</a></li><li><a href=/tags/%EC%9A%B4%EC%98%81/>운영</a></li><li><a href=/tags/issue/>issue</a></li></ul><nav class=paginav><a class=prev href=/mysql/mysql_5715_datetime_issue/><span class=title>« Prev Page</span><br><span>MySQL 5.7.15 Master-Slave datetime 이슈</span></a>
<a class=next href=/mysql/mysql_window_function/><span class=title>Next Page »</span><br><span>MySQL5.7에서 window function 구현하기</span></a></nav></footer><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='kimdubia';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2021 <a href>kimDuBiA</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerText='copy';function copyingDone(){copybutton.innerText='copied!';setTimeout(()=>{copybutton.innerText='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>
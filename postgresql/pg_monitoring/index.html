<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PostgreSQL Monitoring | kimDuBiA</title><meta name=keywords content="postgresql,monitoring"><meta name=description content="PostgreSQL 모니터링은 Prometheus,alertmanager,grafana를 활용하여 구축할 수 있습니다.
방법은 이전에 MySQL 모니터링 구축하는 방법에 대해 공유했던 글을 참고 부탁드리며
 https://kimdubi.github.io/mysql/mysql_pmm/ https://kimdubi.github.io/mysql/alertmanager/  이번 글에서는 제가 사용하는 모니터링 항목과 그에 따른 alert rule을 공유드리겠습니다.
exporter  exporter 기동 커맨드  ### postgres_exporter wget https://github.com/wrouesnel/postgres_exporter/releases/download/v0.8.0/postgres_exporter_v0.8.0_linux-amd64.tar.gz export DATA_SOURCE_NAME=&#34;postgresql://login:password@hostname:port/dbname&#34; ./postgres_exporter --exclude-databases=&#34;template0,template1&#34; --web.listen-address=:9187 --extend.query-path='./queries.yaml' queries.yaml postgres_exporter 는 DB 내 pg_stat* view 의 데이터를 긁어오는데 이외에도 다른 데이터를 수집하고 싶다면
exporter 기동 시 –extend.query-path=’./queries.yaml’ 옵션을 지정해주고 queries."><meta name=author content="kimdubi"><link rel=canonical href=/postgresql/pg_monitoring/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.2dbef8664bbfb3e83a0a44fd4a8fc5010240dbcd1dbc1400753b928b497b8f5e.css integrity="sha256-Lb74Zku/s+g6CkT9So/FAQJA280dvBQAdTuSi0l7j14=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-123-45','auto');ga('send','pageview');}</script><meta property="og:title" content="PostgreSQL Monitoring"><meta property="og:description" content="PostgreSQL 모니터링은 Prometheus,alertmanager,grafana를 활용하여 구축할 수 있습니다.
방법은 이전에 MySQL 모니터링 구축하는 방법에 대해 공유했던 글을 참고 부탁드리며
 https://kimdubi.github.io/mysql/mysql_pmm/ https://kimdubi.github.io/mysql/alertmanager/  이번 글에서는 제가 사용하는 모니터링 항목과 그에 따른 alert rule을 공유드리겠습니다.
exporter  exporter 기동 커맨드  ### postgres_exporter wget https://github.com/wrouesnel/postgres_exporter/releases/download/v0.8.0/postgres_exporter_v0.8.0_linux-amd64.tar.gz export DATA_SOURCE_NAME=&#34;postgresql://login:password@hostname:port/dbname&#34; ./postgres_exporter --exclude-databases=&#34;template0,template1&#34; --web.listen-address=:9187 --extend.query-path='./queries.yaml' queries.yaml postgres_exporter 는 DB 내 pg_stat* view 의 데이터를 긁어오는데 이외에도 다른 데이터를 수집하고 싶다면
exporter 기동 시 –extend.query-path=’./queries.yaml’ 옵션을 지정해주고 queries."><meta property="og:type" content="article"><meta property="og:url" content="/postgresql/pg_monitoring/"><meta property="og:image" content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="postgresql"><meta property="article:published_time" content="2021-10-06T00:07:10+09:00"><meta property="article:modified_time" content="2021-10-06T00:07:10+09:00"><meta property="og:site_name" content="kimDuBiA"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="PostgreSQL Monitoring"><meta name=twitter:description content="PostgreSQL 모니터링은 Prometheus,alertmanager,grafana를 활용하여 구축할 수 있습니다.
방법은 이전에 MySQL 모니터링 구축하는 방법에 대해 공유했던 글을 참고 부탁드리며
 https://kimdubi.github.io/mysql/mysql_pmm/ https://kimdubi.github.io/mysql/alertmanager/  이번 글에서는 제가 사용하는 모니터링 항목과 그에 따른 alert rule을 공유드리겠습니다.
exporter  exporter 기동 커맨드  ### postgres_exporter wget https://github.com/wrouesnel/postgres_exporter/releases/download/v0.8.0/postgres_exporter_v0.8.0_linux-amd64.tar.gz export DATA_SOURCE_NAME=&#34;postgresql://login:password@hostname:port/dbname&#34; ./postgres_exporter --exclude-databases=&#34;template0,template1&#34; --web.listen-address=:9187 --extend.query-path='./queries.yaml' queries.yaml postgres_exporter 는 DB 내 pg_stat* view 의 데이터를 긁어오는데 이외에도 다른 데이터를 수집하고 싶다면
exporter 기동 시 –extend.query-path=’./queries.yaml’ 옵션을 지정해주고 queries."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Postgresqls","item":"/postgresql/"},{"@type":"ListItem","position":3,"name":"PostgreSQL Monitoring","item":"/postgresql/pg_monitoring/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PostgreSQL Monitoring","name":"PostgreSQL Monitoring","description":"PostgreSQL 모니터링은 Prometheus,alertmanager,grafana를 활용하여 구축할 수 있습니다.\n방법은 이전에 MySQL 모니터링 구축하는 방법에 대해 공유했던 글을 참고 부탁드리며\n https://kimdubi.github.io/mysql/mysql_pmm/ https://kimdubi.github.io/mysql/alertmanager/  이번 글에서는 제가 사용하는 모니터링 항목과 그에 따른 alert rule을 공유드리겠습니다.\nexporter  exporter 기동 커맨드  ### postgres_exporter wget https://github.com/wrouesnel/postgres_exporter/releases/download/v0.8.0/postgres_exporter_v0.8.0_linux-amd64.tar.gz export DATA_SOURCE_NAME=\u0026quot;postgresql://login:password@hostname:port/dbname\u0026quot; ./postgres_exporter --exclude-databases=\u0026quot;template0,template1\u0026quot; --web.listen-address=:9187 --extend.query-path='./queries.yaml' queries.yaml postgres_exporter 는 DB 내 pg_stat* view 의 데이터를 긁어오는데 이외에도 다른 데이터를 수집하고 싶다면\nexporter 기동 시 –extend.query-path=’./queries.yaml’ 옵션을 지정해주고 queries.","keywords":["postgresql","monitoring"],"articleBody":" PostgreSQL 모니터링은 Prometheus,alertmanager,grafana를 활용하여 구축할 수 있습니다.\n방법은 이전에 MySQL 모니터링 구축하는 방법에 대해 공유했던 글을 참고 부탁드리며\n https://kimdubi.github.io/mysql/mysql_pmm/ https://kimdubi.github.io/mysql/alertmanager/  이번 글에서는 제가 사용하는 모니터링 항목과 그에 따른 alert rule을 공유드리겠습니다.\nexporter  exporter 기동 커맨드  ### postgres_exporter wget https://github.com/wrouesnel/postgres_exporter/releases/download/v0.8.0/postgres_exporter_v0.8.0_linux-amd64.tar.gz export DATA_SOURCE_NAME=\"postgresql://login:password@hostname:port/dbname\" ./postgres_exporter --exclude-databases=\"template0,template1\" --web.listen-address=:9187 --extend.query-path='./queries.yaml' queries.yaml postgres_exporter 는 DB 내 pg_stat* view 의 데이터를 긁어오는데 이외에도 다른 데이터를 수집하고 싶다면\nexporter 기동 시 –extend.query-path=’./queries.yaml’ 옵션을 지정해주고 queries.yaml 파일에 그 내용을 작성해야 합니다.\npg_replication: query: \"SELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0 ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp()) END AS log_delay, CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END AS is_replica;\" master: true metrics: - lag: usage: \"GAUGE\" description: \"Replication lag behind master in seconds\" - is_replica: usage: \"GAUGE\" description: \"Indicates if this host is a replica\" pg_postmaster: query: \"SELECT pg_postmaster_start_time as start_time_seconds from pg_postmaster_start_time()\" master: true metrics: - start_time_seconds: usage: \"GAUGE\" description: \"Time at which postmaster started\" pg_stat_user_tables: query: \"SELECT current_database() datname, schemaname, relname, seq_scan, seq_tup_read, idx_scan, idx_tup_fetch, n_tup_ins, n_tup_upd, n_tup_del, n_tup_hot_upd, n_live_tup, n_dead_tup, n_mod_since_analyze, COALESCE(last_vacuum, '1970-01-01Z'), COALESCE(last_vacuum, '1970-01-01Z') as last_vacuum, COALESCE(last_autovacuum, '1970-01-01Z') as last_autovacuum, COALESCE(last_analyze, '1970-01-01Z') as last_analyze, COALESCE(last_autoanalyze, '1970-01-01Z') as last_autoanalyze, vacuum_count, autovacuum_count, analyze_count, autoanalyze_count FROM pg_stat_user_tables\" metrics: - datname: usage: \"LABEL\" description: \"Name of current database\" - schemaname: usage: \"LABEL\" description: \"Name of the schema that this table is in\" - relname: usage: \"LABEL\" description: \"Name of this table\" - seq_scan: usage: \"COUNTER\" description: \"Number of sequential scans initiated on this table\" - seq_tup_read: usage: \"COUNTER\" description: \"Number of live rows fetched by sequential scans\" - idx_scan: usage: \"COUNTER\" description: \"Number of index scans initiated on this table\" - idx_tup_fetch: usage: \"COUNTER\" description: \"Number of live rows fetched by index scans\" - n_tup_ins: usage: \"COUNTER\" description: \"Number of rows inserted\" - n_tup_upd: usage: \"COUNTER\" description: \"Number of rows updated\" - n_tup_del: usage: \"COUNTER\" description: \"Number of rows deleted\" - n_tup_hot_upd: usage: \"COUNTER\" description: \"Number of rows HOT updated (i.e., with no separate index update required)\" - n_live_tup: usage: \"GAUGE\" description: \"Estimated number of live rows\" - n_dead_tup: usage: \"GAUGE\" description: \"Estimated number of dead rows\" - n_mod_since_analyze: usage: \"GAUGE\" description: \"Estimated number of rows changed since last analyze\" - last_vacuum: usage: \"GAUGE\" description: \"Last time at which this table was manually vacuumed (not counting VACUUM FULL)\" - last_autovacuum: usage: \"GAUGE\" description: \"Last time at which this table was vacuumed by the autovacuum daemon\" - last_analyze: usage: \"GAUGE\" description: \"Last time at which this table was manually analyzed\" - last_autoanalyze: usage: \"GAUGE\" description: \"Last time at which this table was analyzed by the autovacuum daemon\" - vacuum_count: usage: \"COUNTER\" description: \"Number of times this table has been manually vacuumed (not counting VACUUM FULL)\" - autovacuum_count: usage: \"COUNTER\" description: \"Number of times this table has been vacuumed by the autovacuum daemon\" - analyze_count: usage: \"COUNTER\" description: \"Number of times this table has been manually analyzed\" - autoanalyze_count: usage: \"COUNTER\" description: \"Number of times this table has been analyzed by the autovacuum daemon\" pg_statio_user_tables: query: \"SELECT current_database() datname, schemaname, relname, heap_blks_read, heap_blks_hit, idx_blks_read, idx_blks_hit, toast_blks_read, toast_blks_hit, tidx_blks_read, tidx_blks_hit FROM pg_statio_user_tables\" metrics: - datname: usage: \"LABEL\" description: \"Name of current database\" - schemaname: usage: \"LABEL\" description: \"Name of the schema that this table is in\" - relname: usage: \"LABEL\" description: \"Name of this table\" - heap_blks_read: usage: \"COUNTER\" description: \"Number of disk blocks read from this table\" - heap_blks_hit: usage: \"COUNTER\" description: \"Number of buffer hits in this table\" - idx_blks_read: usage: \"COUNTER\" description: \"Number of disk blocks read from all indexes on this table\" - idx_blks_hit: usage: \"COUNTER\" description: \"Number of buffer hits in all indexes on this table\" - toast_blks_read: usage: \"COUNTER\" description: \"Number of disk blocks read from this table's TOAST table (if any)\" - toast_blks_hit: usage: \"COUNTER\" description: \"Number of buffer hits in this table's TOAST table (if any)\" - tidx_blks_read: usage: \"COUNTER\" description: \"Number of disk blocks read from this table's TOAST table indexes (if any)\" - tidx_blks_hit: usage: \"COUNTER\" description: \"Number of buffer hits in this table's TOAST table indexes (if any)\" pg_database: query: \"SELECT pg_database.datname, pg_database_size(pg_database.datname) as size_bytes FROM pg_database\" master: true cache_seconds: 30 metrics: - datname: usage: \"LABEL\" description: \"Name of the database\" - size_bytes: usage: \"GAUGE\" description: \"Disk space used by the database\" pg_stat_statements: query: \"SELECT t2.rolname, t3.datname, queryid, calls, total_time / 1000 as total_time_seconds, min_time / 1000 as min_time_seconds, max_time / 1000 as max_time_seconds, mean_time / 1000 as mean_time_seconds, stddev_time / 1000 as stddev_time_seconds, rows, shared_blks_hit, shared_blks_read, shared_blks_dirtied, shared_blks_written, local_blks_hit, local_blks_read, local_blks_dirtied, local_blks_written, temp_blks_read, temp_blks_written, blk_read_time / 1000 as blk_read_time_seconds, blk_write_time / 1000 as blk_write_time_seconds FROM pg_stat_statements t1 JOIN pg_roles t2 ON (t1.userid=t2.oid) JOIN pg_database t3 ON (t1.dbid=t3.oid) WHERE t2.rolname != 'rdsadmin'\" master: true metrics: - rolname: usage: \"LABEL\" description: \"Name of user\" - datname: usage: \"LABEL\" description: \"Name of database\" - queryid: usage: \"LABEL\" description: \"Query ID\" - calls: usage: \"COUNTER\" description: \"Number of times executed\" - total_time_seconds: usage: \"COUNTER\" description: \"Total time spent in the statement, in milliseconds\" - min_time_seconds: usage: \"GAUGE\" description: \"Minimum time spent in the statement, in milliseconds\" - max_time_seconds: usage: \"GAUGE\" description: \"Maximum time spent in the statement, in milliseconds\" - mean_time_seconds: usage: \"GAUGE\" description: \"Mean time spent in the statement, in milliseconds\" - stddev_time_seconds: usage: \"GAUGE\" description: \"Population standard deviation of time spent in the statement, in milliseconds\" - rows: usage: \"COUNTER\" description: \"Total number of rows retrieved or affected by the statement\" - shared_blks_hit: usage: \"COUNTER\" description: \"Total number of shared block cache hits by the statement\" - shared_blks_read: usage: \"COUNTER\" description: \"Total number of shared blocks read by the statement\" - shared_blks_dirtied: usage: \"COUNTER\" description: \"Total number of shared blocks dirtied by the statement\" - shared_blks_written: usage: \"COUNTER\" description: \"Total number of shared blocks written by the statement\" - local_blks_hit: usage: \"COUNTER\" description: \"Total number of local block cache hits by the statement\" - local_blks_read: usage: \"COUNTER\" description: \"Total number of local blocks read by the statement\" - local_blks_dirtied: usage: \"COUNTER\" description: \"Total number of local blocks dirtied by the statement\" - local_blks_written: usage: \"COUNTER\" description: \"Total number of local blocks written by the statement\" - temp_blks_read: usage: \"COUNTER\" description: \"Total number of temp blocks read by the statement\" - temp_blks_written: usage: \"COUNTER\" description: \"Total number of temp blocks written by the statement\" - blk_read_time_seconds: usage: \"COUNTER\" description: \"Total time the statement spent reading blocks, in milliseconds (if track_io_timing is enabled, otherwise zero)\" - blk_write_time_seconds: usage: \"COUNTER\" description: \"Total time the statement spent writing blocks, in milliseconds (if track_io_timing is enabled, otherwise zero)\" pg_replication_slots: query: \"SELECT slot_name, slot_type,case when active then 1.0 else 0.0 end AS active, age(xmin) AS xmin_age, age(catalog_xmin) AS catalog_xmin_age FROM pg_replication_slots\" metrics: - slot_name: usage: \"LABEL\" description: \"Slot Name\" - slot_type: usage: \"LABEL\" description: \"Slot Type\" - active: usage: \"GAUGE\" description: \"Boolean flag indicating whether this slot has a consumer streaming from it\" - xmin_age: usage: \"GAUGE\" description: \"Age of oldest transaction that cannot be vacuumed due to this replica\" - catalog_xmin_age: usage: \"GAUGE\" description: \"Age of oldest transaction that cannot be vacuumed from catalogs due to this replica\"  queries.yaml 수정  버전별 replication , vacuum 관련 테이블이 다를 수 있음  #### pg =10 SELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0 ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp()) END AS log_delay, CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END AS is_replica; #### pg alertmanager ### postgresql down - alert: PostgresqlDown expr: pg_up == 0 for: 5m labels: severity: critical annotations: summary: \"Postgresql down (instance {{ $labels.instance }})\" description: \"Postgresql instance is down\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### postgresql restarted - alert: PostgresqlRestarted expr: time() - pg_postmaster_start_time_seconds 600 for: 5m labels: severity: warning annotations: summary: \"Postgresql replication lag (instance {{ $labels.instance }})\" description: \"PostgreSQL replication lag is going up ( 600s)\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### table not vacuumed - alert: PostgresqlTableNotVaccumed expr: time() - pg_stat_user_tables_last_autovacuum  60 * 60 * 24 for: 5m labels: severity: warning annotations: summary: \"Postgresql table not vaccumed (instance {{ $labels.instance }})\" description: \"Table has not been vaccum for 24 hours\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### too many connections - alert: PostgresqlTooManyConnections expr: sum by (datname) (pg_stat_activity_count{datname!~\"template.*|postgres\"})  pg_settings_max_connections * 0.9 for: 5m labels: severity: warning annotations: summary: \"Postgresql too many connections (instance {{ $labels.instance }})\" description: \"PostgreSQL instance has too many connections\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### slow queries - alert: PostgresqlSlowQueries expr: IF avg(rate(pg_stat_activity_max_tx_duration{datname!~\"template.*\"}[2m])) by (datname)  2 * 60 for: 5m labels: severity: warning annotations: summary: \"Postgresql slow queries (instance {{ $labels.instance }})\" description: \"PostgreSQL executes slow queries\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### unused replication slot - alert: PostgresqlUnusedReplicationSlot expr: pg_replication_slots_active == 0 for: 5m labels: severity: warning annotations: summary: \"Postgresql unused replication slot (instance {{ $labels.instance }})\" description: \"Unused Replication Slots\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### too many dead tuples - alert: PostgresqlTooManyDeadTuples expr: ((pg_stat_user_tables_n_dead_tup  10000) / (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup)) = 0.1 unless ON(instance) (pg_replication_is_replica == 1) for: 5m labels: severity: warning annotations: summary: \"Postgresql too many dead tuples (instance {{ $labels.instance }})\" description: \"PostgreSQL dead tuples is too large\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### standby promoted - alert: PostgresqlPromotedNode expr: pg_replication_is_replica and changes(pg_replication_is_replica[1m])  0 for: 5m labels: severity: warning annotations: summary: \"Postgresql promoted node (instance {{ $labels.instance }})\" description: \"Postgresql standby server has been promoted as primary node\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\" ### too many locks aquired - alert: PostgresqlTooManyLocksAcquired expr: ((sum (pg_locks_count)) / (pg_settings_max_locks_per_transaction * pg_settings_max_connections))  0.20 for: 5m labels: severity: critical annotations: summary: \"Postgresql too many locks acquired (instance {{ $labels.instance }})\" description: \"Too many locks acquired on the database. If this alert happens frequently, we may need to increase the postgres setting max_locks_per_transaction.\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}\"  ","wordCount":"1686","inLanguage":"en","datePublished":"2021-10-06T00:07:10+09:00","dateModified":"2021-10-06T00:07:10+09:00","author":{"@type":"Person","name":"kimdubi"},"mainEntityOfPage":{"@type":"WebPage","@id":"/postgresql/pg_monitoring/"},"publisher":{"@type":"Organization","name":"kimDuBiA","logo":{"@type":"ImageObject","url":"%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=/categories/ title=categories><span>categories</span></a></li><li><a href=/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href>Home</a>&nbsp;»&nbsp;<a href=/postgresql/>Postgresqls</a></div><h1 class=post-title>PostgreSQL Monitoring</h1><div class=post-meta>October 6, 2021&nbsp;·&nbsp;8 min&nbsp;·&nbsp;kimdubi</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#exporter aria-label=exporter>exporter</a></li><li><a href=#queriesyaml aria-label=queries.yaml>queries.yaml</a></li><li><a href=#queriesyaml-%ec%88%98%ec%a0%95 aria-label="queries.yaml 수정">queries.yaml 수정</a></li><li><a href=#alertmanager aria-label=alertmanager>alertmanager</a></li></ul></div></details></div><div class=post-content><hr><p>PostgreSQL 모니터링은 Prometheus,alertmanager,grafana를 활용하여 구축할 수 있습니다.<br>방법은 이전에 MySQL 모니터링 구축하는 방법에 대해 공유했던 글을 참고 부탁드리며</p><ul><li><a href=https://kimdubi.github.io/mysql/mysql_pmm/>https://kimdubi.github.io/mysql/mysql_pmm/</a></li><li><a href=https://kimdubi.github.io/mysql/alertmanager/>https://kimdubi.github.io/mysql/alertmanager/</a></li></ul><p>이번 글에서는 제가 사용하는 모니터링 항목과 그에 따른 alert rule을 공유드리겠습니다.</p><h3 id=exporter>exporter<a hidden class=anchor aria-hidden=true href=#exporter>#</a></h3><ul><li>exporter 기동 커맨드</li></ul><pre><code>### postgres_exporter
wget https://github.com/wrouesnel/postgres_exporter/releases/download/v0.8.0/postgres_exporter_v0.8.0_linux-amd64.tar.gz
    
export DATA_SOURCE_NAME=&quot;postgresql://login:password@hostname:port/dbname&quot;
./postgres_exporter --exclude-databases=&quot;template0,template1&quot; --web.listen-address=:9187  --extend.query-path='./queries.yaml'
</code></pre><h3 id=queriesyaml>queries.yaml<a hidden class=anchor aria-hidden=true href=#queriesyaml>#</a></h3><p>postgres_exporter 는 DB 내 pg_stat* view 의 데이터를 긁어오는데 이외에도 다른 데이터를 수집하고 싶다면<br>exporter 기동 시 –extend.query-path=’./queries.yaml’ 옵션을 지정해주고 queries.yaml 파일에 그 내용을 작성해야 합니다.</p><pre><code>pg_replication:
  query: &quot;SELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0 ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp()) END AS log_delay, CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END AS is_replica;&quot;
  master: true
  metrics:
    - lag:
        usage: &quot;GAUGE&quot;
        description: &quot;Replication lag behind master in seconds&quot;
    - is_replica:
        usage: &quot;GAUGE&quot;
        description: &quot;Indicates if this host is a replica&quot;

pg_postmaster:
  query: &quot;SELECT pg_postmaster_start_time as start_time_seconds from pg_postmaster_start_time()&quot;
  master: true
  metrics:
    - start_time_seconds:
        usage: &quot;GAUGE&quot;
        description: &quot;Time at which postmaster started&quot;

pg_stat_user_tables:
  query: &quot;SELECT current_database() datname, schemaname, relname, seq_scan, seq_tup_read, idx_scan, idx_tup_fetch, n_tup_ins, n_tup_upd, n_tup_del, n_tup_hot_upd, n_live_tup, n_dead_tup, n_mod_since_analyze, COALESCE(last_vacuum, '1970-01-01Z'), COALESCE(last_vacuum, '1970-01-01Z') as last_vacuum, COALESCE(last_autovacuum, '1970-01-01Z') as last_autovacuum, COALESCE(last_analyze, '1970-01-01Z') as last_analyze, COALESCE(last_autoanalyze, '1970-01-01Z') as last_autoanalyze, vacuum_count, autovacuum_count, analyze_count, autoanalyze_count FROM pg_stat_user_tables&quot;
  metrics:
    - datname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of current database&quot;
    - schemaname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of the schema that this table is in&quot;
    - relname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of this table&quot;
    - seq_scan:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of sequential scans initiated on this table&quot;
    - seq_tup_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of live rows fetched by sequential scans&quot;
    - idx_scan:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of index scans initiated on this table&quot;
    - idx_tup_fetch:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of live rows fetched by index scans&quot;
    - n_tup_ins:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of rows inserted&quot;
    - n_tup_upd:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of rows updated&quot;
    - n_tup_del:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of rows deleted&quot;
    - n_tup_hot_upd:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of rows HOT updated (i.e., with no separate index update required)&quot;
    - n_live_tup:
        usage: &quot;GAUGE&quot;
        description: &quot;Estimated number of live rows&quot;
    - n_dead_tup:
        usage: &quot;GAUGE&quot;
        description: &quot;Estimated number of dead rows&quot;
    - n_mod_since_analyze:
        usage: &quot;GAUGE&quot;
        description: &quot;Estimated number of rows changed since last analyze&quot;
    - last_vacuum:
        usage: &quot;GAUGE&quot;
        description: &quot;Last time at which this table was manually vacuumed (not counting VACUUM FULL)&quot;
    - last_autovacuum:
        usage: &quot;GAUGE&quot;
        description: &quot;Last time at which this table was vacuumed by the autovacuum daemon&quot;
    - last_analyze:
        usage: &quot;GAUGE&quot;
        description: &quot;Last time at which this table was manually analyzed&quot;
    - last_autoanalyze:
        usage: &quot;GAUGE&quot;
        description: &quot;Last time at which this table was analyzed by the autovacuum daemon&quot;
    - vacuum_count:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of times this table has been manually vacuumed (not counting VACUUM FULL)&quot;
    - autovacuum_count:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of times this table has been vacuumed by the autovacuum daemon&quot;
    - analyze_count:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of times this table has been manually analyzed&quot;
    - autoanalyze_count:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of times this table has been analyzed by the autovacuum daemon&quot;

pg_statio_user_tables:
  query: &quot;SELECT current_database() datname, schemaname, relname, heap_blks_read, heap_blks_hit, idx_blks_read, idx_blks_hit, toast_blks_read, toast_blks_hit, tidx_blks_read, tidx_blks_hit FROM pg_statio_user_tables&quot;
  metrics:
    - datname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of current database&quot;
    - schemaname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of the schema that this table is in&quot;
    - relname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of this table&quot;
    - heap_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of disk blocks read from this table&quot;
    - heap_blks_hit:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of buffer hits in this table&quot;
    - idx_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of disk blocks read from all indexes on this table&quot;
    - idx_blks_hit:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of buffer hits in all indexes on this table&quot;
    - toast_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of disk blocks read from this table's TOAST table (if any)&quot;
    - toast_blks_hit:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of buffer hits in this table's TOAST table (if any)&quot;
    - tidx_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of disk blocks read from this table's TOAST table indexes (if any)&quot;
    - tidx_blks_hit:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of buffer hits in this table's TOAST table indexes (if any)&quot;

pg_database:
  query: &quot;SELECT pg_database.datname, pg_database_size(pg_database.datname) as size_bytes FROM pg_database&quot;
  master: true
  cache_seconds: 30
  metrics:
    - datname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of the database&quot;
    - size_bytes:
        usage: &quot;GAUGE&quot;
        description: &quot;Disk space used by the database&quot;

pg_stat_statements:
  query: &quot;SELECT t2.rolname, t3.datname, queryid, calls, total_time / 1000 as total_time_seconds, min_time / 1000 as min_time_seconds, max_time / 1000 as max_time_seconds, mean_time / 1000 as mean_time_seconds, stddev_time / 1000 as stddev_time_seconds, rows, shared_blks_hit, shared_blks_read, shared_blks_dirtied, shared_blks_written, local_blks_hit, local_blks_read, local_blks_dirtied, local_blks_written, temp_blks_read, temp_blks_written, blk_read_time / 1000 as blk_read_time_seconds, blk_write_time / 1000 as blk_write_time_seconds FROM pg_stat_statements t1 JOIN pg_roles t2 ON (t1.userid=t2.oid) JOIN pg_database t3 ON (t1.dbid=t3.oid) WHERE t2.rolname != 'rdsadmin'&quot;
  master: true
  metrics:
    - rolname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of user&quot;
    - datname:
        usage: &quot;LABEL&quot;
        description: &quot;Name of database&quot;
    - queryid:
        usage: &quot;LABEL&quot;
        description: &quot;Query ID&quot;
    - calls:
        usage: &quot;COUNTER&quot;
        description: &quot;Number of times executed&quot;
    - total_time_seconds:
        usage: &quot;COUNTER&quot;
        description: &quot;Total time spent in the statement, in milliseconds&quot;
    - min_time_seconds:
        usage: &quot;GAUGE&quot;
        description: &quot;Minimum time spent in the statement, in milliseconds&quot;
    - max_time_seconds:
        usage: &quot;GAUGE&quot;
        description: &quot;Maximum time spent in the statement, in milliseconds&quot;
    - mean_time_seconds:
        usage: &quot;GAUGE&quot;
        description: &quot;Mean time spent in the statement, in milliseconds&quot;
    - stddev_time_seconds:
        usage: &quot;GAUGE&quot;
        description: &quot;Population standard deviation of time spent in the statement, in milliseconds&quot;
    - rows:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of rows retrieved or affected by the statement&quot;
    - shared_blks_hit:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of shared block cache hits by the statement&quot;
    - shared_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of shared blocks read by the statement&quot;
    - shared_blks_dirtied:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of shared blocks dirtied by the statement&quot;
    - shared_blks_written:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of shared blocks written by the statement&quot;
    - local_blks_hit:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of local block cache hits by the statement&quot;
    - local_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of local blocks read by the statement&quot;
    - local_blks_dirtied:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of local blocks dirtied by the statement&quot;
    - local_blks_written:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of local blocks written by the statement&quot;
    - temp_blks_read:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of temp blocks read by the statement&quot;
    - temp_blks_written:
        usage: &quot;COUNTER&quot;
        description: &quot;Total number of temp blocks written by the statement&quot;
    - blk_read_time_seconds:
        usage: &quot;COUNTER&quot;
        description: &quot;Total time the statement spent reading blocks, in milliseconds (if track_io_timing is enabled, otherwise zero)&quot;
    - blk_write_time_seconds:
        usage: &quot;COUNTER&quot;
        description: &quot;Total time the statement spent writing blocks, in milliseconds (if track_io_timing is enabled, otherwise zero)&quot;

pg_replication_slots: 
  query: &quot;SELECT slot_name, slot_type,case when active then 1.0 else 0.0 end AS active, age(xmin) AS xmin_age, age(catalog_xmin) AS catalog_xmin_age FROM pg_replication_slots&quot;
  metrics:
    - slot_name:
        usage: &quot;LABEL&quot;
        description: &quot;Slot Name&quot; 
    - slot_type:
        usage: &quot;LABEL&quot;
        description: &quot;Slot Type&quot; 
    - active:
        usage: &quot;GAUGE&quot;
        description: &quot;Boolean flag indicating whether this slot has a consumer streaming from it&quot; 
    - xmin_age:
        usage: &quot;GAUGE&quot;
        description: &quot;Age of oldest transaction that cannot be vacuumed due to this replica&quot; 
    - catalog_xmin_age:
        usage: &quot;GAUGE&quot;
        description: &quot;Age of oldest transaction that cannot be vacuumed from catalogs due to this replica&quot;
</code></pre><h3 id=queriesyaml-수정>queries.yaml 수정<a hidden class=anchor aria-hidden=true href=#queriesyaml-수정>#</a></h3><ul><li>버전별 replication , vacuum 관련 테이블이 다를 수 있음</li></ul><pre><code>#### pg &gt;=10
SELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn()
THEN 0
ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())
END AS log_delay,
CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END AS is_replica;
    
#### pg &lt;10
SELECT CASE WHEN pg_last_xlog_receive_location() = pg_last_xlog_replay_location()
THEN 0
ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())
END AS log_delay,
CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END AS is_replica;
</code></pre><h3 id=alertmanager>alertmanager<a hidden class=anchor aria-hidden=true href=#alertmanager>#</a></h3><pre><code>### postgresql down
- alert: PostgresqlDown
    expr: pg_up == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: &quot;Postgresql down (instance {{ $labels.instance }})&quot;
      description: &quot;Postgresql instance is down\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### postgresql restarted
- alert: PostgresqlRestarted
    expr: time() - pg_postmaster_start_time_seconds &lt; 60
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: &quot;Postgresql restarted (instance {{ $labels.instance }})&quot;
      description: &quot;Postgresql restarted\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### replication lag
- alert: PostgresqlReplicationLag
    expr: (pg_replication_lag) &gt; 600
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql replication lag (instance {{ $labels.instance }})&quot;
      description: &quot;PostgreSQL replication lag is going up (&gt; 600s)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### table not vacuumed
- alert: PostgresqlTableNotVaccumed
    expr: time() - pg_stat_user_tables_last_autovacuum &gt; 60 * 60 * 24
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql table not vaccumed (instance {{ $labels.instance }})&quot;
      description: &quot;Table has not been vaccum for 24 hours\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;

### too many connections

 - alert: PostgresqlTooManyConnections
    expr: sum by (datname) (pg_stat_activity_count{datname!~&quot;template.*|postgres&quot;}) &gt; pg_settings_max_connections * 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql too many connections (instance {{ $labels.instance }})&quot;
      description: &quot;PostgreSQL instance has too many connections\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### slow queries

- alert: PostgresqlSlowQueries
    expr: IF avg(rate(pg_stat_activity_max_tx_duration{datname!~&quot;template.*&quot;}[2m])) by (datname) &gt; 2 * 60
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql slow queries (instance {{ $labels.instance }})&quot;
      description: &quot;PostgreSQL executes slow queries\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### unused replication slot
 - alert: PostgresqlUnusedReplicationSlot
    expr: pg_replication_slots_active == 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql unused replication slot (instance {{ $labels.instance }})&quot;
      description: &quot;Unused Replication Slots\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### too many dead tuples
- alert: PostgresqlTooManyDeadTuples
    expr: ((pg_stat_user_tables_n_dead_tup &gt; 10000) / (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup)) &gt;= 0.1 unless ON(instance) (pg_replication_is_replica == 1)
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql too many dead tuples (instance {{ $labels.instance }})&quot;
      description: &quot;PostgreSQL dead tuples is too large\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### standby promoted
- alert: PostgresqlPromotedNode
    expr: pg_replication_is_replica and changes(pg_replication_is_replica[1m]) &gt; 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Postgresql promoted node (instance {{ $labels.instance }})&quot;
      description: &quot;Postgresql standby server has been promoted as primary node\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
      
### too many locks aquired
 - alert: PostgresqlTooManyLocksAcquired
    expr: ((sum (pg_locks_count)) / (pg_settings_max_locks_per_transaction * pg_settings_max_connections)) &gt; 0.20
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: &quot;Postgresql too many locks acquired (instance {{ $labels.instance }})&quot;
      description: &quot;Too many locks acquired on the database. If this alert happens frequently, we may need to increase the postgres setting max_locks_per_transaction.\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}&quot;
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=/tags/postgresql/>postgresql</a></li><li><a href=/tags/monitoring/>monitoring</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href>kimDuBiA</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerText='copy';function copyingDone(){copybutton.innerText='copied!';setTimeout(()=>{copybutton.innerText='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>
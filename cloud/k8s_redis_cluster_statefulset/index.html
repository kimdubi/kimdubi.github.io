<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes에서 redis cluster를 돌려보자 - Statefulset | kimDuBiA</title><meta name=keywords content="kubernetes,redis"><meta name=description content="StatefulSet ? StatefulSet 개념  StatefulSet은 Pod을 scale up&down 하여 새로 배포 할 때 각 Pod의 기존 Spec(hostname,Ip등) 을 유지하여 생성함 (stateful) stateless 한 deployment, replicaset 과는 다른점임 Pod 별로 각각의 PVC를 사용하거나 Pod 생성 순서가 중요할 때 (Master / Slave 구성이 필요할떄) statefulset 을 사용하여 Ordering을 보장하고 구분지을 수 있음 위 구성을 replicaSet , delpoyment를 사용했다면 pod-0 , pod-1 이 같은 PVC,PV를 사용하여 Pod 고유의 state가 사라지고 , 재기동 될 때마다 IP,hostname이 달라져 headless Service를 사용할 수 없음  StatefulSet 사용 현황 $ kubectl get statefulset NAME READY AGE kimdubi-test-redis-cluster 6/6 2d4h   statefulset 하나로 Pod 6대를 관리함, Pod이 down되어도 statefulset에 의해 자동으로 restart 됨 Pod,pvc 생성 구문은 statefulset 에서 정의됨  StatefulSet template을 살펴보자 $ kubectl get statefulset kimdubi-test-redis-cluster -o yaml apiVersion: apps/v1 kind: StatefulSet metadata: annotations: meta."><meta name=author content="kimdubi"><link rel=canonical href=/cloud/k8s_redis_cluster_statefulset/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.2dbef8664bbfb3e83a0a44fd4a8fc5010240dbcd1dbc1400753b928b497b8f5e.css integrity="sha256-Lb74Zku/s+g6CkT9So/FAQJA280dvBQAdTuSi0l7j14=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-123-45','auto');ga('send','pageview');}</script><meta property="og:title" content="Kubernetes에서 redis cluster를 돌려보자 - Statefulset"><meta property="og:description" content="StatefulSet ? StatefulSet 개념  StatefulSet은 Pod을 scale up&down 하여 새로 배포 할 때 각 Pod의 기존 Spec(hostname,Ip등) 을 유지하여 생성함 (stateful) stateless 한 deployment, replicaset 과는 다른점임 Pod 별로 각각의 PVC를 사용하거나 Pod 생성 순서가 중요할 때 (Master / Slave 구성이 필요할떄) statefulset 을 사용하여 Ordering을 보장하고 구분지을 수 있음 위 구성을 replicaSet , delpoyment를 사용했다면 pod-0 , pod-1 이 같은 PVC,PV를 사용하여 Pod 고유의 state가 사라지고 , 재기동 될 때마다 IP,hostname이 달라져 headless Service를 사용할 수 없음  StatefulSet 사용 현황 $ kubectl get statefulset NAME READY AGE kimdubi-test-redis-cluster 6/6 2d4h   statefulset 하나로 Pod 6대를 관리함, Pod이 down되어도 statefulset에 의해 자동으로 restart 됨 Pod,pvc 생성 구문은 statefulset 에서 정의됨  StatefulSet template을 살펴보자 $ kubectl get statefulset kimdubi-test-redis-cluster -o yaml apiVersion: apps/v1 kind: StatefulSet metadata: annotations: meta."><meta property="og:type" content="article"><meta property="og:url" content="/cloud/k8s_redis_cluster_statefulset/"><meta property="og:image" content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="cloud"><meta property="article:published_time" content="2021-10-06T17:55:37+09:00"><meta property="article:modified_time" content="2021-10-06T17:55:37+09:00"><meta property="og:site_name" content="kimDuBiA"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Kubernetes에서 redis cluster를 돌려보자 - Statefulset"><meta name=twitter:description content="StatefulSet ? StatefulSet 개념  StatefulSet은 Pod을 scale up&down 하여 새로 배포 할 때 각 Pod의 기존 Spec(hostname,Ip등) 을 유지하여 생성함 (stateful) stateless 한 deployment, replicaset 과는 다른점임 Pod 별로 각각의 PVC를 사용하거나 Pod 생성 순서가 중요할 때 (Master / Slave 구성이 필요할떄) statefulset 을 사용하여 Ordering을 보장하고 구분지을 수 있음 위 구성을 replicaSet , delpoyment를 사용했다면 pod-0 , pod-1 이 같은 PVC,PV를 사용하여 Pod 고유의 state가 사라지고 , 재기동 될 때마다 IP,hostname이 달라져 headless Service를 사용할 수 없음  StatefulSet 사용 현황 $ kubectl get statefulset NAME READY AGE kimdubi-test-redis-cluster 6/6 2d4h   statefulset 하나로 Pod 6대를 관리함, Pod이 down되어도 statefulset에 의해 자동으로 restart 됨 Pod,pvc 생성 구문은 statefulset 에서 정의됨  StatefulSet template을 살펴보자 $ kubectl get statefulset kimdubi-test-redis-cluster -o yaml apiVersion: apps/v1 kind: StatefulSet metadata: annotations: meta."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Clouds","item":"/cloud/"},{"@type":"ListItem","position":3,"name":"Kubernetes에서 redis cluster를 돌려보자 - Statefulset","item":"/cloud/k8s_redis_cluster_statefulset/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes에서 redis cluster를 돌려보자 - Statefulset","name":"Kubernetes에서 redis cluster를 돌려보자 - Statefulset","description":"StatefulSet ? StatefulSet 개념  StatefulSet은 Pod을 scale up\u0026amp;down 하여 새로 배포 할 때 각 Pod의 기존 Spec(hostname,Ip등) 을 유지하여 생성함 (stateful) stateless 한 deployment, replicaset 과는 다른점임 Pod 별로 각각의 PVC를 사용하거나 Pod 생성 순서가 중요할 때 (Master / Slave 구성이 필요할떄) statefulset 을 사용하여 Ordering을 보장하고 구분지을 수 있음 위 구성을 replicaSet , delpoyment를 사용했다면 pod-0 , pod-1 이 같은 PVC,PV를 사용하여 Pod 고유의 state가 사라지고 , 재기동 될 때마다 IP,hostname이 달라져 headless Service를 사용할 수 없음  StatefulSet 사용 현황 $ kubectl get statefulset NAME READY AGE kimdubi-test-redis-cluster 6/6 2d4h   statefulset 하나로 Pod 6대를 관리함, Pod이 down되어도 statefulset에 의해 자동으로 restart 됨 Pod,pvc 생성 구문은 statefulset 에서 정의됨  StatefulSet template을 살펴보자 $ kubectl get statefulset kimdubi-test-redis-cluster -o yaml apiVersion: apps/v1 kind: StatefulSet metadata: annotations: meta.","keywords":["kubernetes","redis"],"articleBody":" StatefulSet ? StatefulSet 개념  StatefulSet은 Pod을 scale up\u0026down 하여 새로 배포 할 때 각 Pod의 기존 Spec(hostname,Ip등) 을 유지하여 생성함 (stateful) stateless 한 deployment, replicaset 과는 다른점임 Pod 별로 각각의 PVC를 사용하거나 Pod 생성 순서가 중요할 때 (Master / Slave 구성이 필요할떄) statefulset 을 사용하여 Ordering을 보장하고 구분지을 수 있음 위 구성을 replicaSet , delpoyment를 사용했다면 pod-0 , pod-1 이 같은 PVC,PV를 사용하여 Pod 고유의 state가 사라지고 , 재기동 될 때마다 IP,hostname이 달라져 headless Service를 사용할 수 없음  StatefulSet 사용 현황 $ kubectl get statefulset NAME READY AGE kimdubi-test-redis-cluster 6/6 2d4h   statefulset 하나로 Pod 6대를 관리함, Pod이 down되어도 statefulset에 의해 자동으로 restart 됨 Pod,pvc 생성 구문은 statefulset 에서 정의됨  StatefulSet template을 살펴보자 $ kubectl get statefulset kimdubi-test-redis-cluster -o yaml apiVersion: apps/v1 kind: StatefulSet metadata: annotations: meta.helm.sh/release-name: kimdubi-test meta.helm.sh/release-namespace: default creationTimestamp: \"2021-02-21T07:33:55Z\" generation: 1 labels: app.kubernetes.io/instance: kimdubi-test app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: redis-cluster helm.sh/chart: redis-cluster-4.3.0 name: kimdubi-test-redis-cluster namespace: default resourceVersion: \"358350\" selfLink: /apis/apps/v1/namespaces/default/statefulsets/kimdubi-test-redis-cluster uid: b348894a-e930-4dc2-ba10-c8566eeec0b9 spec: podManagementPolicy: Parallel replicas: 6 revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/instance: kimdubi-test app.kubernetes.io/name: redis-cluster serviceName: kimdubi-test-redis-cluster-headless template: metadata: annotations: checksum/scripts: 13c84ab100b949b2a69989dbcfa1079e3d930ee56d79744da9abc6d691709923 checksum/secret: 3fb9c96414bd6f5e1a0841de974fcb260231a9c12bebb2c49af0f02b651e47cf creationTimestamp: null labels: app.kubernetes.io/instance: kimdubi-test app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: redis-cluster helm.sh/chart: redis-cluster-4.3.0 spec: affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - podAffinityTerm: labelSelector: matchLabels: app.kubernetes.io/instance: kimdubi-test app.kubernetes.io/name: redis-cluster namespaces: - default topologyKey: kubernetes.io/hostname weight: 1 containers: - args: - | # Backwards compatibility change if ! [[ -f /opt/bitnami/redis/etc/redis.conf ]]; then echo COPYING FILE cp /opt/bitnami/redis/etc/redis-default.conf /opt/bitnami/redis/etc/redis.conf fi /opt/bitnami/scripts/redis-cluster/entrypoint.sh /opt/bitnami/scripts/redis-cluster/run.sh command: - /bin/bash - -c env: - name: REDIS_NODES value: 'kimdubi-test-redis-cluster-0.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-1.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-2.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-3.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-4.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-5.kimdubi-test-redis-cluster-headless ' - name: REDISCLI_AUTH valueFrom: secretKeyRef: key: redis-password name: kimdubi-test-redis-cluster - name: REDIS_PASSWORD valueFrom: secretKeyRef: key: redis-password name: kimdubi-test-redis-cluster - name: REDIS_AOF_ENABLED value: \"yes\" - name: REDIS_TLS_ENABLED value: \"no\" - name: REDIS_PORT value: \"6379\" image: docker.io/bitnami/redis-cluster:6.0.10-debian-10-r5 imagePullPolicy: IfNotPresent livenessProbe: exec: command: - sh - -c - /scripts/ping_liveness_local.sh 5 failureThreshold: 5 initialDelaySeconds: 5 periodSeconds: 5 successThreshold: 1 timeoutSeconds: 5 name: kimdubi-test-redis-cluster ports: - containerPort: 6379 name: tcp-redis protocol: TCP - containerPort: 16379 name: tcp-redis-bus protocol: TCP readinessProbe: exec: command: - sh - -c - /scripts/ping_readiness_local.sh 1 failureThreshold: 5 initialDelaySeconds: 5 periodSeconds: 5 successThreshold: 1 timeoutSeconds: 1 resources: limits: cpu: 100m memory: 100Mi requests: cpu: 50m memory: 50Mi securityContext: runAsUser: 1001 terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /scripts name: scripts - mountPath: /bitnami/redis/data name: redis-data - mountPath: /opt/bitnami/redis/etc/redis-default.conf name: default-config subPath: redis-default.conf - mountPath: /opt/bitnami/redis/etc/ name: redis-tmp-conf dnsPolicy: ClusterFirst enableServiceLinks: false restartPolicy: Always schedulerName: default-scheduler securityContext: fsGroup: 1001 serviceAccount: default serviceAccountName: default terminationGracePeriodSeconds: 30 volumes: - configMap: defaultMode: 493 name: kimdubi-test-redis-cluster-scripts name: scripts - configMap: defaultMode: 420 name: kimdubi-test-redis-cluster-default name: default-config - emptyDir: {} name: redis-tmp-conf updateStrategy: type: RollingUpdate volumeClaimTemplates: - apiVersion: v1 kind: PersistentVolumeClaim metadata: creationTimestamp: null name: redis-data spec: accessModes: - ReadWriteOnce resources: requests: storage: 2Gi storageClassName: kimdubi-test volumeMode: Filesystem status: phase: Pending status: collisionCount: 0 currentReplicas: 6 currentRevision: kimdubi-test-redis-cluster-86585bd988 observedGeneration: 1 readyReplicas: 6 replicas: 6 updateRevision: kimdubi-test-redis-cluster-86585bd988 updatedReplicas: 6  .spec.replicas  statefulset 에서 관리할 동일한 스펙의 Pod를 6대만큼 생성하겠다는 설정 생성할 Pod의 상세 설정은 .spec.template.spec에 정의 되어있음  .spec.selector.matchLabels  statefulset 에서 관리할 Pod를 구분짓는 조건 Pod의 label과 .spec.selector.matchLabels가 동일한지 체크를 통해 관리할 Pod를 구분함  .spec.serviceName  statefulset 으로 생성된 Pod 들이 사용할 Service statefulset 에선 Pod에 직접 access할 수 있는 DNS를 할당하기 위해 headless service를 사용함 관련 내용은 service편에서..  .spec.template.metadata.labels  생성할 Pod의 label 을 설정하는 부분, .spec.selector.matchLabels의 label과 일치해야함  .spec.updateStrategy.type  statefulset 을 통해 배포할 때 Pod이 배포되는 방식을 설정 RollingUpdate : Ordering 된 Pod 들을 마지막 Pod부터 순서대로 재생성하여 배포함 onDelete : Pod을 수동으로 삭제 했을 때 새로운 설정이 반영된 Pod가 생성됨  .spec.volumeClaimTemplates  statefulset 에 의해 생성되고 관리되는 Pod에 하나씩 binding 해줄 PVC 정의 부분 정의한 PVC를 .spec.template.spec.containers.volumeMounts 를 통해 container의 /bitnami/redis/data 디렉토리에 binding하고 있음  ","wordCount":"589","inLanguage":"en","datePublished":"2021-10-06T17:55:37+09:00","dateModified":"2021-10-06T17:55:37+09:00","author":{"@type":"Person","name":"kimdubi"},"mainEntityOfPage":{"@type":"WebPage","@id":"/cloud/k8s_redis_cluster_statefulset/"},"publisher":{"@type":"Organization","name":"kimDuBiA","logo":{"@type":"ImageObject","url":"%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=/categories/ title=categories><span>categories</span></a></li><li><a href=/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href>Home</a>&nbsp;»&nbsp;<a href=/cloud/>Clouds</a></div><h1 class=post-title>Kubernetes에서 redis cluster를 돌려보자 - Statefulset</h1><div class=post-meta>October 6, 2021&nbsp;·&nbsp;3 min&nbsp;·&nbsp;kimdubi</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#statefulset- aria-label="StatefulSet ?">StatefulSet ?</a><ul><li><a href=#statefulset-%ea%b0%9c%eb%85%90 aria-label="StatefulSet 개념">StatefulSet 개념</a></li><li><a href=#statefulset-%ec%82%ac%ec%9a%a9-%ed%98%84%ed%99%a9 aria-label="StatefulSet 사용 현황">StatefulSet 사용 현황</a></li></ul></li><li><a href=#statefulset-template%ec%9d%84-%ec%82%b4%ed%8e%b4%eb%b3%b4%ec%9e%90 aria-label="StatefulSet template을 살펴보자">StatefulSet template을 살펴보자</a><ul><ul><li><a href=#specreplicas aria-label=.spec.replicas>.spec.replicas</a></li><li><a href=#specselectormatchlabels aria-label=.spec.selector.matchLabels>.spec.selector.matchLabels</a></li><li><a href=#specservicename aria-label=.spec.serviceName>.spec.serviceName</a></li><li><a href=#spectemplatemetadatalabels aria-label=.spec.template.metadata.labels>.spec.template.metadata.labels</a></li><li><a href=#specupdatestrategytype aria-label=.spec.updateStrategy.type>.spec.updateStrategy.type</a></li><li><a href=#specvolumeclaimtemplates aria-label=.spec.volumeClaimTemplates>.spec.volumeClaimTemplates</a></li></ul></ul></li></ul></div></details></div><div class=post-content><hr><h1 id=statefulset->StatefulSet ?<a hidden class=anchor aria-hidden=true href=#statefulset->#</a></h1><h2 id=statefulset-개념>StatefulSet 개념<a hidden class=anchor aria-hidden=true href=#statefulset-개념>#</a></h2><p><img loading=lazy src=https://raw.githubusercontent.com/kimdubi/kimdubi.github.io/master/images/cloud/k8s/k8s_redis_sfs01.png alt></p><ul><li>StatefulSet은 Pod을 scale up&down 하여 새로 배포 할 때 각 Pod의 기존 Spec(hostname,Ip등) 을 유지하여 생성함 (stateful)</li><li>stateless 한 deployment, replicaset 과는 다른점임</li><li>Pod 별로 각각의 PVC를 사용하거나 Pod 생성 순서가 중요할 때 (Master / Slave 구성이 필요할떄) statefulset 을 사용하여 Ordering을 보장하고 구분지을 수 있음</li><li>위 구성을 replicaSet , delpoyment를 사용했다면 pod-0 , pod-1 이 같은 PVC,PV를 사용하여 Pod 고유의 state가 사라지고 , 재기동 될 때마다 IP,hostname이 달라져 headless Service를 사용할 수 없음</li></ul><h2 id=statefulset-사용-현황>StatefulSet 사용 현황<a hidden class=anchor aria-hidden=true href=#statefulset-사용-현황>#</a></h2><pre><code>$ kubectl get statefulset
NAME                         READY   AGE
kimdubi-test-redis-cluster   6/6     2d4h
</code></pre><ul><li>statefulset 하나로 Pod 6대를 관리함, Pod이 down되어도 statefulset에 의해 자동으로 restart 됨</li><li>Pod,pvc 생성 구문은 statefulset 에서 정의됨</li></ul><h1 id=statefulset-template을-살펴보자>StatefulSet template을 살펴보자<a hidden class=anchor aria-hidden=true href=#statefulset-template을-살펴보자>#</a></h1><pre><code>$ kubectl get statefulset kimdubi-test-redis-cluster -o yaml

apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    meta.helm.sh/release-name: kimdubi-test
    meta.helm.sh/release-namespace: default
  creationTimestamp: &quot;2021-02-21T07:33:55Z&quot;
  generation: 1
  labels:
    app.kubernetes.io/instance: kimdubi-test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redis-cluster
    helm.sh/chart: redis-cluster-4.3.0
  name: kimdubi-test-redis-cluster
  namespace: default
  resourceVersion: &quot;358350&quot;
  selfLink: /apis/apps/v1/namespaces/default/statefulsets/kimdubi-test-redis-cluster
  uid: b348894a-e930-4dc2-ba10-c8566eeec0b9
spec:
  podManagementPolicy: Parallel
  replicas: 6
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app.kubernetes.io/instance: kimdubi-test
      app.kubernetes.io/name: redis-cluster
  serviceName: kimdubi-test-redis-cluster-headless
  template:
    metadata:
      annotations:
        checksum/scripts: 13c84ab100b949b2a69989dbcfa1079e3d930ee56d79744da9abc6d691709923
        checksum/secret: 3fb9c96414bd6f5e1a0841de974fcb260231a9c12bebb2c49af0f02b651e47cf
      creationTimestamp: null
      labels:
        app.kubernetes.io/instance: kimdubi-test
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: redis-cluster
        helm.sh/chart: redis-cluster-4.3.0
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/instance: kimdubi-test
                  app.kubernetes.io/name: redis-cluster
              namespaces:
              - default
              topologyKey: kubernetes.io/hostname
            weight: 1
      containers:
      - args:
        - |
          # Backwards compatibility change
          if ! [[ -f /opt/bitnami/redis/etc/redis.conf ]]; then
              echo COPYING FILE
              cp  /opt/bitnami/redis/etc/redis-default.conf /opt/bitnami/redis/etc/redis.conf
          fi
          /opt/bitnami/scripts/redis-cluster/entrypoint.sh /opt/bitnami/scripts/redis-cluster/run.sh
        command:
        - /bin/bash
        - -c
        env:
        - name: REDIS_NODES
          value: 'kimdubi-test-redis-cluster-0.kimdubi-test-redis-cluster-headless
            kimdubi-test-redis-cluster-1.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-2.kimdubi-test-redis-cluster-headless
            kimdubi-test-redis-cluster-3.kimdubi-test-redis-cluster-headless kimdubi-test-redis-cluster-4.kimdubi-test-redis-cluster-headless
            kimdubi-test-redis-cluster-5.kimdubi-test-redis-cluster-headless '
        - name: REDISCLI_AUTH
          valueFrom:
            secretKeyRef:
              key: redis-password
              name: kimdubi-test-redis-cluster
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              key: redis-password
              name: kimdubi-test-redis-cluster
        - name: REDIS_AOF_ENABLED
          value: &quot;yes&quot;
        - name: REDIS_TLS_ENABLED
          value: &quot;no&quot;
        - name: REDIS_PORT
          value: &quot;6379&quot;
        image: docker.io/bitnami/redis-cluster:6.0.10-debian-10-r5
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - /scripts/ping_liveness_local.sh 5
          failureThreshold: 5
          initialDelaySeconds: 5
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 5
        name: kimdubi-test-redis-cluster
        ports:
        - containerPort: 6379
          name: tcp-redis
          protocol: TCP
        - containerPort: 16379
          name: tcp-redis-bus
          protocol: TCP
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - /scripts/ping_readiness_local.sh 1
          failureThreshold: 5
          initialDelaySeconds: 5
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 50m
            memory: 50Mi
        securityContext:
          runAsUser: 1001
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /scripts
          name: scripts
        - mountPath: /bitnami/redis/data
          name: redis-data
        - mountPath: /opt/bitnami/redis/etc/redis-default.conf
          name: default-config
          subPath: redis-default.conf
        - mountPath: /opt/bitnami/redis/etc/
          name: redis-tmp-conf
      dnsPolicy: ClusterFirst
      enableServiceLinks: false
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
        fsGroup: 1001
      serviceAccount: default
      serviceAccountName: default
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 493
          name: kimdubi-test-redis-cluster-scripts
        name: scripts
      - configMap:
          defaultMode: 420
          name: kimdubi-test-redis-cluster-default
        name: default-config
      - emptyDir: {}
        name: redis-tmp-conf
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      creationTimestamp: null
      name: redis-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 2Gi
      storageClassName: kimdubi-test
      volumeMode: Filesystem
    status:
      phase: Pending
status:
  collisionCount: 0
  currentReplicas: 6
  currentRevision: kimdubi-test-redis-cluster-86585bd988
  observedGeneration: 1
  readyReplicas: 6
  replicas: 6
  updateRevision: kimdubi-test-redis-cluster-86585bd988
  updatedReplicas: 6
</code></pre><h3 id=specreplicas>.spec.replicas<a hidden class=anchor aria-hidden=true href=#specreplicas>#</a></h3><ul><li>statefulset 에서 관리할 동일한 스펙의 Pod를 6대만큼 생성하겠다는 설정</li><li>생성할 Pod의 상세 설정은 .spec.template.spec에 정의 되어있음</li></ul><h3 id=specselectormatchlabels>.spec.selector.matchLabels<a hidden class=anchor aria-hidden=true href=#specselectormatchlabels>#</a></h3><ul><li>statefulset 에서 관리할 Pod를 구분짓는 조건</li><li>Pod의 label과 .spec.selector.matchLabels가 동일한지 체크를 통해 관리할 Pod를 구분함</li></ul><h3 id=specservicename>.spec.serviceName<a hidden class=anchor aria-hidden=true href=#specservicename>#</a></h3><ul><li>statefulset 으로 생성된 Pod 들이 사용할 Service</li><li>statefulset 에선 Pod에 직접 access할 수 있는 DNS를 할당하기 위해 headless service를 사용함</li><li>관련 내용은 service편에서..</li></ul><h3 id=spectemplatemetadatalabels>.spec.template.metadata.labels<a hidden class=anchor aria-hidden=true href=#spectemplatemetadatalabels>#</a></h3><ul><li>생성할 Pod의 label 을 설정하는 부분, .spec.selector.matchLabels의 label과 일치해야함</li></ul><h3 id=specupdatestrategytype>.spec.updateStrategy.type<a hidden class=anchor aria-hidden=true href=#specupdatestrategytype>#</a></h3><ul><li>statefulset 을 통해 배포할 때 Pod이 배포되는 방식을 설정</li><li>RollingUpdate : Ordering 된 Pod 들을 마지막 Pod부터 순서대로 재생성하여 배포함</li><li>onDelete : Pod을 수동으로 삭제 했을 때 새로운 설정이 반영된 Pod가 생성됨</li></ul><h3 id=specvolumeclaimtemplates>.spec.volumeClaimTemplates<a hidden class=anchor aria-hidden=true href=#specvolumeclaimtemplates>#</a></h3><ul><li>statefulset 에 의해 생성되고 관리되는 Pod에 하나씩 binding 해줄 PVC 정의 부분</li><li>정의한 PVC를 .spec.template.spec.containers.volumeMounts 를 통해 container의 /bitnami/redis/data 디렉토리에 binding하고 있음</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=/tags/kubernetes/>kubernetes</a></li><li><a href=/tags/redis/>redis</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href>kimDuBiA</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerText='copy';function copyingDone(){copybutton.innerText='copied!';setTimeout(()=>{copybutton.innerText='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>